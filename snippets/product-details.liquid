{%- liquid
  assign show_vendor = block.settings.show_vendor | default: false
  assign show_sku = block.settings.show_sku | default: false
  assign show_quantity_selector = block.settings.show_quantity_selector | default: true
-%}

<div {{ block.shopify_attributes }}>
{% if show_vendor and product.vendor != blank %}
  <div class="product-vendor mb-2" style="font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 0.1em;">
    {{ product.vendor }}
  </div>
{% endif %}

<h1 class="product-title mb-3">{{ product.title }}</h1>

<div class="product-price mb-4">
  {% if product.compare_at_price > product.price %}
    <span class="product-price-compare text-muted text-decoration-line-through me-2" style="font-size: 18px;">
      {{ product.compare_at_price | money }}
    </span>
    <span class="product-price-current text-danger" style="font-size: 24px; font-weight: 600;">
      {{ product.price | money }}
    </span>
    <span class="product-price-save ms-2" style="color: var(--primary-orange, #FF6B35); font-weight: 600;">
      Save {{ product.compare_at_price | minus: product.price | money }}
    </span>
  {% else %}
    <span class="product-price-current" style="font-size: 28px; font-weight: 600;">
      {{ product.price | money }}
    </span>
  {% endif %}
</div>

{% if show_sku and product.selected_or_first_available_variant.sku != blank %}
  <div class="product-sku mb-4" style="font-size: 14px; color: #666;">
    SKU: <strong>{{ product.selected_or_first_available_variant.sku }}</strong>
  </div>
{% endif %}

{%- comment -%} Render app embeds and other blocks before the form {%- endcomment -%}
{%- liquid
  assign product_details_block_id = block.id
  assign found_product_details = false
-%}
{% for section_block in section.blocks %}
  {%- comment -%} Find blocks that come after product-details block {%- endcomment -%}
  {% if section_block.id == product_details_block_id %}
    {% assign found_product_details = true %}
  {% elsif found_product_details and section_block.type != 'product-details' and section_block.type != 'product-media-gallery' and section_block.type != 'product-description' %}
    <div class="product-details-block mb-4" {{ section_block.shopify_attributes }}>
      {% case section_block.type %}
        {% when 'text' %}
          <div class="product-details-text">
            {{ section_block.settings.text }}
          </div>
        {% when 'richtext' %}
          <div class="product-details-richtext">
            {{ section_block.settings.richtext }}
          </div>
        {% when 'product-description' %}
          {%- comment -%} Product description blocks are now rendered directly in product-main-content.liquid to respect block order {%- endcomment -%}
        {% when 'html' %}
          <div class="product-details-html">
            {{ section_block.settings.html }}
          </div>
        {% when 'liquid' %}
          <div class="product-details-liquid">
            {{ section_block.settings.liquid }}
          </div>
        {% when '@app' %}
          {%- comment -%} App embeds (like Sesami) - render with product context {%- endcomment -%}
          <div class="product-details-app-embed" data-product-id="{{ product.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
            {% render section_block %}
          </div>
        {% else %}
          {% render section_block %}
      {% endcase %}
    </div>
  {% endif %}
{% endfor %}

{% if product.available == false %}
  <div class="alert alert-danger mb-4" role="alert">
    This product is currently out of stock.
  </div>
{% else %}
  <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="product-form" data-product-id="{{ product.id }}" class="product-form">
    <!-- Variants Card -->
    {% if product.variants.size > 1 %}
      <div class="card mb-3" style="background-color: #f8f9fa;">
        <div class="card-body">
          <h6 class="card-title mb-3 fw-semibold">Select Options</h6>
          <input type="hidden" name="id" id="selected-variant-id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
          {% for option in product.options_with_values %}
            <div class="mb-3">
              <label for="option-{{ forloop.index }}" class="form-label fw-semibold mb-2">
                {{ option.name }}
              </label>
              <select 
                id="option-{{ forloop.index }}"
                class="form-select product-option-select"
                required
                data-option-index="{{ option.position | minus: 1 }}"
                onchange="updateSelectedVariant()">
                {% for value in option.values %}
                  <option 
                    value="{{ value | escape }}"
                    {% if option.selected_value == value %}selected{% endif %}>
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <input type="hidden" name="id" id="selected-variant-id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
    {% endif %}

    <!-- Quantity Card -->
    {% if show_quantity_selector %}
      <div class="card mb-3" style="background-color: #f8f9fa;">
        <div class="card-body">
          <label for="quantity" class="form-label fw-semibold mb-2">Quantity</label>
          <div class="input-group" style="max-width: 200px;">
            <button 
              type="button" 
              class="btn btn-outline-secondary"
              onclick="decreaseQuantity()"
              style="border-color: #dee2e6;">
              <i class="bi bi-dash"></i>
            </button>
            <input 
              type="number" 
              id="quantity" 
              name="quantity" 
              value="1" 
              min="1" 
              class="form-control text-center"
              style="border-color: #dee2e6;">
            <button 
              type="button" 
              class="btn btn-outline-secondary"
              onclick="increaseQuantity()"
              style="border-color: #dee2e6;">
              <i class="bi bi-plus"></i>
            </button>
          </div>
        </div>
      </div>
    {% else %}
      <input type="hidden" name="quantity" value="1" id="quantity">
    {% endif %}

    <!-- Add to Cart and Buy Now Buttons -->
    <div class="card mb-3" style="background-color: #f8f9fa;">
      <div class="card-body">
        <div class="d-flex flex-column gap-3">
          <!-- Add to Cart Button -->
          <button 
            type="submit" 
            name="add" 
            id="add-to-cart-btn"
            class="btn btn-primary w-100"
            style="height: 50px; font-size: 18px; font-weight: 600;"
            {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
            <i class="bi bi-cart-plus me-2"></i>
            {% if product.selected_or_first_available_variant.available %}
              Add to Cart
            {% else %}
              Out of Stock
            {% endif %}
          </button>

          <!-- Buy Now Button (Direct Checkout) -->
          <button 
            type="button" 
            id="buy-now-btn"
            class="btn btn-success w-100"
            style="height: 50px; font-size: 18px; font-weight: 600; background-color: #28a745; border-color: #28a745;"
            {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
            <i class="bi bi-bag-check me-2"></i>
            Buy Now
          </button>
        </div>
      </div>
    </div>
  </form>
{% endif %}
</div>
