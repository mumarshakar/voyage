{% comment %}
  sections/booking-calendar.liquid
  A custom section to display a booking calendar with event images.
  Supports multiple months with interactive navigation.
  Admin: Uses date picker fields in theme customizer
  Frontend: Interactive calendar with month navigation
{% endcomment %}

{%- liquid
  assign section_bg_color = section.settings.background_color | default: '#F8F7F5'
  assign padding_top = section.settings.padding_top | default: 60
  assign padding_bottom = section.settings.padding_bottom | default: 60
  assign padding_horizontal = section.settings.padding_horizontal | default: 20
  assign margin_top = section.settings.margin_top | default: 0
  assign margin_bottom = section.settings.margin_bottom | default: 0
  assign heading_color = section.settings.heading_color | default: '#8B6F47'
  assign weekday_color = section.settings.weekday_color | default: '#8B6F47'
  assign day_number_color = section.settings.day_number_color | default: '#333333'
  assign heading_font_family = section.settings.heading_font_family | default: 'Playfair Display, serif'
  assign weekday_font_family = section.settings.weekday_font_family | default: 'Playfair Display, serif'
  assign months_gap = section.settings.months_gap | default: 60
  assign show_navigation = section.settings.show_navigation | default: true
  
  # Telr payment settings
  assign telr_store_id = settings.telr_store_id | default: ''
  assign telr_auth_key = settings.telr_auth_key | default: ''
  assign telr_environment = settings.telr_environment | default: 'test'
  assign telr_success_url = settings.telr_success_url | default: ''
  assign telr_cancel_url = settings.telr_cancel_url | default: ''
  assign telr_failed_url = settings.telr_failed_url | default: ''
  assign telr_currency = settings.telr_currency | default: 'AED'
  
  # Booking confirmation page URL
  assign confirmation_page_url = section.settings.confirmation_page_url | default: ''
  if confirmation_page_url == blank
    assign confirmation_page_url = routes.root_url | append: '?booking=confirm'
  endif
  
  # Use home page as fallback if URLs are not set
  if telr_success_url == blank
    assign telr_success_url = routes.root_url | append: '?booking=success'
  endif
  if telr_cancel_url == blank
    assign telr_cancel_url = routes.root_url | append: '?booking=cancel'
  endif
  if telr_failed_url == blank
    assign telr_failed_url = routes.root_url | append: '?booking=failed'
  endif
-%}

<div class="booking-calendar-section"
     id="booking-calendar-{{ section.id }}"
     style="background-color: {{ section_bg_color }};
            padding-top: {{ padding_top }}px;
            padding-bottom: {{ padding_bottom }}px;
            padding-left: {{ padding_horizontal }}px;
            padding-right: {{ padding_horizontal }}px;
            margin-top: {{ margin_top }}px;
            margin-bottom: {{ margin_bottom }}px;">

  {% comment %} Collect all month blocks and parse dates {% endcomment %}
  {% assign month_blocks = section.blocks | where: 'type', 'month' %}
  
  {% if month_blocks.size > 0 %}
    {% for month_block in month_blocks %}
      {%- liquid
        assign month_date_string = month_block.settings.month_date | default: ''
        if month_date_string != blank
          assign month_date_parts = month_date_string | split: '-'
          assign year_number = month_date_parts[0] | plus: 0
          assign month_number = month_date_parts[1] | plus: 0
        else
          assign month_number = 11
          assign year_number = 2025
        endif
      -%}
      
      <div class="calendar-month-container" 
           data-month="{{ month_number }}" 
           data-year="{{ year_number }}"
           data-block-id="{{ month_block.id }}"
           data-initial-month="{{ month_number }}"
           data-initial-year="{{ year_number }}"
           style="margin-bottom: {{ months_gap }}px;">
        
        <div class="calendar-header">
          {% if show_navigation %}
            <button class="calendar-nav-arrow calendar-nav-prev" 
                    aria-label="Previous Month"
                    style="color: {{ heading_color }};"
                    type="button">
              {% render 'icon-arrow-left' %}
            </button>
          {% endif %}
          
          <div class="calendar-month-year-selector" style="flex: 1; display: flex; justify-content: center; align-items: center; gap: 10px;">
            <select class="calendar-month-select" 
                    style="color: {{ heading_color }}; font-family: {{ heading_font_family }}; font-size: 1.5rem; font-weight: 600; border: none; background: transparent; cursor: pointer; padding: 5px;">
              <option value="1" {% if month_number == 1 %}selected{% endif %}>January</option>
              <option value="2" {% if month_number == 2 %}selected{% endif %}>February</option>
              <option value="3" {% if month_number == 3 %}selected{% endif %}>March</option>
              <option value="4" {% if month_number == 4 %}selected{% endif %}>April</option>
              <option value="5" {% if month_number == 5 %}selected{% endif %}>May</option>
              <option value="6" {% if month_number == 6 %}selected{% endif %}>June</option>
              <option value="7" {% if month_number == 7 %}selected{% endif %}>July</option>
              <option value="8" {% if month_number == 8 %}selected{% endif %}>August</option>
              <option value="9" {% if month_number == 9 %}selected{% endif %}>September</option>
              <option value="10" {% if month_number == 10 %}selected{% endif %}>October</option>
              <option value="11" {% if month_number == 11 %}selected{% endif %}>November</option>
              <option value="12" {% if month_number == 12 %}selected{% endif %}>December</option>
            </select>
            <select class="calendar-year-select" 
                    style="color: {{ heading_color }}; font-family: {{ heading_font_family }}; font-size: 1.5rem; font-weight: 600; border: none; background: transparent; cursor: pointer; padding: 5px;">
              {%- liquid
                assign current_year = 'now' | date: '%Y' | plus: 0
                assign min_year = current_year | minus: 1
                assign max_year = current_year | plus: 2
              -%}
              {% for y in (min_year..max_year) %}
                <option value="{{ y }}" {% if year_number == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          
          {% if show_navigation %}
            <button class="calendar-nav-arrow calendar-nav-next" 
                    aria-label="Next Month"
                    style="color: {{ heading_color }};"
                    type="button">
              {% render 'icon-arrow-right' %}
            </button>
          {% endif %}
        </div>

        <div class="calendar-weekdays" 
             style="color: {{ weekday_color }}; 
                    font-family: {{ weekday_font_family }};">
          <span>SU</span>
          <span>MO</span>
          <span>TU</span>
          <span>WE</span>
          <span>TH</span>
          <span>FR</span>
          <span>SA</span>
        </div>

        <div class="calendar-grid" 
             data-month="{{ month_number }}" 
             data-year="{{ year_number }}"
             data-block-id="{{ month_block.id }}">
          {% comment %} Calendar days will be populated by JavaScript {% endcomment %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    {% comment %} Fallback: Show current month if no months are configured {% endcomment %}
    {%- liquid
      assign current_month = 'now' | date: '%m'
      assign current_year = 'now' | date: '%Y'
      assign current_month_num = current_month | plus: 0
      assign current_year_num = current_year | plus: 0
    -%}
    <div class="calendar-month-container" 
         data-month="{{ current_month_num }}" 
         data-year="{{ current_year_num }}"
         data-initial-month="{{ current_month_num }}"
         data-initial-year="{{ current_year_num }}"
         style="margin-bottom: {{ months_gap }}px;">
      
      <div class="calendar-header">
        {% if show_navigation %}
          <button class="calendar-nav-arrow calendar-nav-prev" 
                  aria-label="Previous Month"
                  style="color: {{ heading_color }};"
                  type="button">
            {% render 'icon-arrow-left' %}
          </button>
        {% endif %}
        
        <div class="calendar-month-year-selector" style="flex: 1; display: flex; justify-content: center; align-items: center; gap: 10px;">
          <select class="calendar-month-select" 
                  style="color: {{ heading_color }}; font-family: {{ heading_font_family }}; font-size: 1.5rem; font-weight: 600; border: none; background: transparent; cursor: pointer; padding: 5px;">
            <option value="1" {% if current_month_num == 1 %}selected{% endif %}>January</option>
            <option value="2" {% if current_month_num == 2 %}selected{% endif %}>February</option>
            <option value="3" {% if current_month_num == 3 %}selected{% endif %}>March</option>
            <option value="4" {% if current_month_num == 4 %}selected{% endif %}>April</option>
            <option value="5" {% if current_month_num == 5 %}selected{% endif %}>May</option>
            <option value="6" {% if current_month_num == 6 %}selected{% endif %}>June</option>
            <option value="7" {% if current_month_num == 7 %}selected{% endif %}>July</option>
            <option value="8" {% if current_month_num == 8 %}selected{% endif %}>August</option>
            <option value="9" {% if current_month_num == 9 %}selected{% endif %}>September</option>
            <option value="10" {% if current_month_num == 10 %}selected{% endif %}>October</option>
            <option value="11" {% if current_month_num == 11 %}selected{% endif %}>November</option>
            <option value="12" {% if current_month_num == 12 %}selected{% endif %}>December</option>
          </select>
          <select class="calendar-year-select" 
                  style="color: {{ heading_color }}; font-family: {{ heading_font_family }}; font-size: 1.5rem; font-weight: 600; border: none; background: transparent; cursor: pointer; padding: 5px;">
            {%- liquid
              assign current_year_for_select = 'now' | date: '%Y' | plus: 0
              assign min_year_fallback = current_year_for_select | minus: 1
              assign max_year_fallback = current_year_for_select | plus: 2
            -%}
            {% for y in (min_year_fallback..max_year_fallback) %}
              <option value="{{ y }}" {% if current_year_num == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
        
        {% if show_navigation %}
          <button class="calendar-nav-arrow calendar-nav-next" 
                  aria-label="Next Month"
                  style="color: {{ heading_color }};"
                  type="button">
            {% render 'icon-arrow-right' %}
          </button>
        {% endif %}
      </div>

      <div class="calendar-weekdays" 
           style="color: {{ weekday_color }}; 
                  font-family: {{ weekday_font_family }};">
        <span>SU</span>
        <span>MO</span>
        <span>TU</span>
        <span>WE</span>
        <span>TH</span>
        <span>FR</span>
        <span>SA</span>
      </div>

      <div class="calendar-grid" 
           data-month="{{ current_month_num }}" 
           data-year="{{ current_year_num }}">
        {% comment %} Calendar days will be populated by JavaScript {% endcomment %}
      </div>
    </div>
  {% endif %}

  {% comment %} Event blocks - parse event dates from date picker {% endcomment %}
  {% for block in section.blocks %}
    {% if block.type == 'event' %}
      {%- liquid
        assign event_date_string = block.settings.event_date | default: ''
        if event_date_string != blank
          assign event_date_parts = event_date_string | split: '-'
          assign event_year = event_date_parts[0] | plus: 0
          assign event_month = event_date_parts[1] | plus: 0
          assign event_day = event_date_parts[2] | plus: 0
        else
          assign event_year = 2025
          assign event_month = 11
          assign event_day = 1
        endif
      -%}
      <div class="event-data" 
           data-event-month="{{ event_month }}"
           data-event-year="{{ event_year }}"
           data-event-day="{{ event_day }}"
           data-event-image="{% if block.settings.event_image != blank %}{{ block.settings.event_image | image_url: width: 400 }}{% endif %}"
           data-event-title="{{ block.settings.event_title | escape }}"
           data-event-link="{{ block.settings.event_link }}"
           data-event-price="{{ block.settings.event_price | default: '0' }}"
           data-event-description="{{ block.settings.event_description | escape }}"
           style="display: none;">
      </div>
    {% endif %}
  {% endfor %}

</div>

<div class="booking-calendar-section"
     id="booking-calendar-{{ section.id }}"
     style="background-color: {{ section_bg_color }};
            padding-top: {{ padding_top }}px;
            padding-bottom: {{ padding_bottom }}px;
            padding-left: {{ padding_horizontal }}px;
            padding-right: {{ padding_horizontal }}px;
            margin-top: {{ margin_top }}px;
            margin-bottom: {{ margin_bottom }}px;">

  {% comment %} Event Details Modal {% endcomment %}
  <div id="event-details-modal-{{ section.id }}" class="event-details-modal" style="display: none;">
    <div class="event-details-modal-overlay"></div>
    <div class="event-details-modal-content">
      <button class="event-details-modal-close" aria-label="Close modal">
        <i class="bi bi-x-lg"></i>
      </button>
      <div class="event-details-content">
        <div class="event-details-image-wrapper">
          <img id="modal-event-image" src="" alt="" class="event-details-image">
        </div>
        <div class="event-details-info">
          <h2 id="modal-event-title" class="event-details-title"></h2>
          <p id="modal-event-date" class="event-details-date"></p>
          <p id="modal-event-description" class="event-details-description"></p>
          <div class="event-details-price">
            <span class="price-label">Price:</span>
            <span id="modal-event-price" class="price-amount"></span>
            <span class="price-currency">{{ telr_currency }}</span>
          </div>
        </div>
      </div>
      <div class="event-details-booking-form">
        <h3>Booking Details</h3>
        {% comment %} Hidden form for Shopify contact form submission {% endcomment %}
        <form id="shopify-booking-form-{{ section.id }}" action="/contact" method="post" style="display: none;">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="âœ“">
          <input type="hidden" name="contact[subject]" id="shopify-booking-subject" value="">
          <input type="hidden" name="contact[email]" id="shopify-booking-email" value="">
          <input type="hidden" name="contact[body]" id="shopify-booking-body" value="">
        </form>
        
        <form id="booking-form-{{ section.id }}" class="booking-form">
          <div class="form-group">
            <label for="booking-name">Full Name *</label>
            <input type="text" id="booking-name" name="name" required>
          </div>
          <div class="form-group">
            <label for="booking-email">Email *</label>
            <input type="email" id="booking-email" name="email" required>
          </div>
          <div class="form-group">
            <label for="booking-phone">Phone Number *</label>
            <input type="tel" id="booking-phone" name="phone" required>
          </div>
          <div class="form-group">
            <label for="booking-notes">Additional Notes (Optional)</label>
            <textarea id="booking-notes" name="notes" rows="3"></textarea>
          </div>
          <input type="hidden" id="booking-event-date" name="event_date">
          <input type="hidden" id="booking-event-title" name="event_title">
          <input type="hidden" id="booking-event-price" name="event_price">
          <button type="submit" class="btn-confirm-booking" id="confirm-booking-btn-{{ section.id }}">
            <span class="btn-text">Confirm Booking</span>
            <span class="btn-loading" style="display: none;">Redirecting to Payment...</span>
          </button>
        </form>
      </div>
    </div>
  </div>

</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const calendarSection = document.getElementById('booking-calendar-{{ section.id }}');
    if (!calendarSection) return;

    // Collect all event data by month-year-day key
    const eventData = {};
    const eventDivs = calendarSection.querySelectorAll('.event-data');
    eventDivs.forEach(div => {
      const month = parseInt(div.dataset.eventMonth) || 1;
      const year = parseInt(div.dataset.eventYear) || 2025;
      const day = parseInt(div.dataset.eventDay);
      if (day && div.dataset.eventImage) {
        const key = `${year}-${month}-${day}`;
        eventData[key] = {
          image: div.dataset.eventImage,
          title: div.dataset.eventTitle || 'Event',
          link: div.dataset.eventLink || '',
          price: div.dataset.eventPrice || '0',
          description: div.dataset.eventDescription || '',
          month: month,
          year: year,
          day: day
        };
      }
    });

    // Month names for display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];

    // Modal elements
    const eventModal = document.getElementById('event-details-modal-{{ section.id }}');
    const modalCloseBtn = eventModal ? eventModal.querySelector('.event-details-modal-close') : null;
    const modalOverlay = eventModal ? eventModal.querySelector('.event-details-modal-overlay') : null;
    const bookingForm = document.getElementById('booking-form-{{ section.id }}');

    // Show event details modal
    function showEventModal(eventInfo, month, day, year) {
      if (!eventModal) return;
      
      const modalImage = eventModal.querySelector('#modal-event-image');
      const modalTitle = eventModal.querySelector('#modal-event-title');
      const modalDate = eventModal.querySelector('#modal-event-date');
      const modalDescription = eventModal.querySelector('#modal-event-description');
      const modalPrice = eventModal.querySelector('#modal-event-price');
      const priceContainer = eventModal.querySelector('.event-details-price');
      const bookingEventDate = document.getElementById('booking-event-date');
      const bookingEventTitle = document.getElementById('booking-event-title');
      const bookingEventPrice = document.getElementById('booking-event-price');
      const confirmButton = eventModal.querySelector('.btn-confirm-booking');
      
      if (modalImage) modalImage.src = eventInfo.image;
      if (modalImage) modalImage.alt = eventInfo.title;
      if (modalTitle) modalTitle.textContent = eventInfo.title;
      if (modalDate) modalDate.textContent = monthNames[month - 1] + ' ' + day + ', ' + year;
      if (modalDescription) {
        if (eventInfo.description && eventInfo.description.trim() !== '') {
          modalDescription.textContent = eventInfo.description;
          modalDescription.style.display = 'block';
        } else {
          modalDescription.style.display = 'none';
        }
      }
      
      const price = parseFloat(eventInfo.price) || 0;
      if (modalPrice) {
        modalPrice.textContent = price.toFixed(2);
      }
      if (priceContainer) {
        if (price > 0) {
          priceContainer.style.display = 'flex';
        } else {
          priceContainer.style.display = 'none';
        }
      }
      
      // Update button text for free/paid events
      const btnTextSpan = eventModal.querySelector('.btn-text');
      if (btnTextSpan) {
        if (price > 0) {
          btnTextSpan.textContent = 'Confirm Booking & Pay';
        } else {
          btnTextSpan.textContent = 'Confirm Booking';
        }
      }
      
      // Set hidden form fields
      if (bookingEventDate) {
        bookingEventDate.value = year + '-' + (month < 10 ? '0' + month : month) + '-' + (day < 10 ? '0' + day : day);
      }
      if (bookingEventTitle) bookingEventTitle.value = eventInfo.title;
      if (bookingEventPrice) bookingEventPrice.value = eventInfo.price || '0';
      
      eventModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close event details modal
    function closeEventModal() {
      if (!eventModal) return;
      eventModal.style.display = 'none';
      document.body.style.overflow = '';
      if (bookingForm) bookingForm.reset();
    }

    // Close modal handlers
    if (modalCloseBtn) {
      modalCloseBtn.addEventListener('click', closeEventModal);
    }
    if (modalOverlay) {
      modalOverlay.addEventListener('click', closeEventModal);
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && eventModal && eventModal.style.display === 'flex') {
        closeEventModal();
      }
    });

    // Function to save booking to Shopify contact form
    function saveBookingToShopify(bookingData, callback) {
      const shopifyForm = document.getElementById('shopify-booking-form-{{ section.id }}');
      if (!shopifyForm) {
        console.warn('Shopify booking form not found');
        if (callback) callback(false);
        return;
      }
      
      // Prepare booking details for email body
      const bookingBody = `Event Booking Request

Order ID: ${bookingData.orderId}
Event: ${bookingData.eventTitle}
Event Date: ${bookingData.eventDate}
Customer Name: ${bookingData.customerName}
Customer Email: ${bookingData.customerEmail}
Customer Phone: ${bookingData.customerPhone}
Amount: ${bookingData.amount} ${bookingData.currency}
Status: ${bookingData.status || 'Pending'}
${bookingData.notes ? 'Additional Notes: ' + bookingData.notes : ''}
Timestamp: ${bookingData.timestamp || new Date().toISOString()}`;
      
      // Set form values
      const subjectInput = document.getElementById('shopify-booking-subject');
      const emailInput = document.getElementById('shopify-booking-email');
      const bodyInput = document.getElementById('shopify-booking-body');
      
      if (subjectInput) subjectInput.value = 'Event Booking: ' + bookingData.eventTitle + ' - ' + bookingData.eventDate;
      if (emailInput) emailInput.value = bookingData.customerEmail;
      if (bodyInput) bodyInput.value = bookingBody;
      
      // Submit form asynchronously using fetch
      const formData = new FormData(shopifyForm);
      
      fetch('/contact', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          console.log('Booking saved to Shopify successfully');
          if (callback) callback(true);
        } else {
          console.warn('Failed to save booking to Shopify');
          if (callback) callback(false);
        }
      })
      .catch(error => {
        console.error('Error saving booking to Shopify:', error);
        if (callback) callback(false);
      });
    }

    // Handle booking form submission
    if (bookingForm) {
      bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const confirmButton = document.getElementById('confirm-booking-btn-{{ section.id }}');
        const btnText = confirmButton ? confirmButton.querySelector('.btn-text') : null;
        const btnLoading = confirmButton ? confirmButton.querySelector('.btn-loading') : null;
        
        // Disable button and show loading state
        if (confirmButton) {
          confirmButton.disabled = true;
          if (btnText) btnText.style.display = 'none';
          if (btnLoading) btnLoading.style.display = 'inline';
        }
        
        const formData = new FormData(bookingForm);
        const eventPrice = formData.get('event_price');
        const price = parseFloat(eventPrice) || 0;
        const name = formData.get('name');
        const email = formData.get('email');
        const phone = formData.get('phone');
        const eventDate = formData.get('event_date');
        const eventTitle = formData.get('event_title');
        const notes = formData.get('notes') || '';
        
        // Generate unique order ID
        const orderId = 'BOOK-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        
        // Prepare booking data
        const bookingData = {
          orderId: orderId,
          eventTitle: eventTitle,
          eventDate: eventDate,
          customerName: name,
          customerEmail: email,
          customerPhone: phone,
          amount: eventPrice || '0',
          currency: '{{ telr_currency }}',
          notes: notes,
          timestamp: new Date().toISOString()
        };
        
        // For free events (price = 0), handle differently
        if (price <= 0) {
          bookingData.status = 'confirmed';
          
          // Store booking data in sessionStorage
          sessionStorage.setItem('booking_data', JSON.stringify(bookingData));
          
          // Save booking to Shopify contact form
          saveBookingToShopify(bookingData, function(success) {
            // Redirect to success page regardless of save status
            const successUrl = '{{ telr_success_url }}';
            if (successUrl.startsWith('http')) {
              window.location.href = successUrl;
            } else {
              window.location.href = '{{ shop.url }}' + successUrl;
            }
          });
          return;
        }
        
        // For paid events, redirect to confirmation page first
        // Validate required fields
        if (!name || !email || !phone) {
          alert('Please fill in all required fields.');
          
          // Re-enable button
          if (confirmButton) {
            confirmButton.disabled = false;
            if (btnText) btnText.style.display = 'inline';
            if (btnLoading) btnLoading.style.display = 'none';
          }
          return;
        }
        
        bookingData.status = 'pending_payment';
        
        // Store booking data in sessionStorage (for confirmation page and success page)
        try {
          sessionStorage.setItem('booking_data', JSON.stringify(bookingData));
        } catch (e) {
          console.warn('Could not store booking data in sessionStorage:', e);
        }
        
        // Save booking to Shopify in background (non-blocking)
        saveBookingToShopify(bookingData, function(success) {
          console.log('Shopify save:', success ? 'OK' : 'Failed');
        });
        
        // Redirect to confirmation page
        const confirmationPageUrl = '{{ confirmation_page_url }}';
        const shopUrl = '{{ shop.url }}';
        
        console.log('Redirecting to confirmation page...');
        
        if (confirmationPageUrl.startsWith('http')) {
          window.location.href = confirmationPageUrl;
        } else {
          window.location.href = shopUrl + confirmationPageUrl;
        }
      });
    }

    // Render calendar for a specific month container
    function renderCalendar(monthContainer) {
      const calendarGrid = monthContainer.querySelector('.calendar-grid');
      const monthSelect = monthContainer.querySelector('.calendar-month-select');
      const yearSelect = monthContainer.querySelector('.calendar-year-select');
      if (!calendarGrid) return;

      let month = parseInt(monthContainer.dataset.month) || 1;
      let year = parseInt(monthContainer.dataset.year) || 2025;

      // Update data attributes
      monthContainer.dataset.month = month;
      monthContainer.dataset.year = year;

      // Update month/year selects
      if (monthSelect) {
        monthSelect.value = month;
      }
      if (yearSelect) {
        yearSelect.value = year;
      }

      // Clear existing days
      calendarGrid.innerHTML = '';

      // Calculate first day of month and days in month
      const firstDayOfMonth = new Date(year, month - 1, 1);
      const lastDayOfMonth = new Date(year, month, 0);
      const daysInMonth = lastDayOfMonth.getDate();
      const startDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sunday, 1 = Monday, etc.

      // Add empty leading days
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('calendar-day', 'empty');
        calendarGrid.appendChild(emptyDay);
      }

      // Add actual days
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('calendar-day');
        dayElement.dataset.day = day;
        dayElement.dataset.month = month;
        dayElement.dataset.year = year;
        
        const dayNumber = document.createElement('span');
        dayNumber.classList.add('day-number');
        dayNumber.style.color = '{{ day_number_color }}';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);

        // Check if this day has an event
        const eventKey = `${year}-${month}-${day}`;
        if (eventData[eventKey]) {
          dayElement.classList.add('has-event');
          const eventInfo = eventData[eventKey];
          
          const imgWrapper = document.createElement('div');
          imgWrapper.classList.add('event-image-wrapper');
          const img = document.createElement('img');
          img.src = eventInfo.image;
          img.alt = eventInfo.title || 'Event';
          img.loading = 'lazy';
          img.width = '400';
          img.height = '300';
          imgWrapper.appendChild(img);
          dayElement.appendChild(imgWrapper);

          // Add click handler for events - always show modal for booking
          dayElement.style.cursor = 'pointer';
          dayElement.addEventListener('click', function(e) {
            e.preventDefault();
            // If event has a link, still show modal but allow external link option
            if (eventInfo.link && eventInfo.link.trim() !== '') {
              // Show modal with option to view details or go to link
              showEventModal(eventInfo, month, day, year);
            } else {
              // Show modal for booking
              showEventModal(eventInfo, month, day, year);
            }
          });
        } else {
          // Make empty days clickable but don't show booking for dates without events
          // You can enable this if you want to allow booking for any date
          // dayElement.style.cursor = 'pointer';
          // dayElement.addEventListener('click', function(e) {
          //   e.preventDefault();
          //   console.log('Date selected: ' + monthNames[month - 1] + ' ' + day + ', ' + year);
          // });
        }

        calendarGrid.appendChild(dayElement);
      }

      // Fill remaining empty cells to complete grid
      const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
      const remainingCells = totalCells - (startDayOfWeek + daysInMonth);
      for (let i = 0; i < remainingCells; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('calendar-day', 'empty');
        calendarGrid.appendChild(emptyDay);
      }
    }

    // Add navigation handlers for each calendar
    const monthContainers = calendarSection.querySelectorAll('.calendar-month-container');
    monthContainers.forEach(container => {
      const prevBtn = container.querySelector('.calendar-nav-prev');
      const nextBtn = container.querySelector('.calendar-nav-next');
      const monthSelect = container.querySelector('.calendar-month-select');
      const yearSelect = container.querySelector('.calendar-year-select');
      
      // Previous month button
      if (prevBtn) {
        prevBtn.addEventListener('click', function() {
          let month = parseInt(container.dataset.month) || 1;
          let year = parseInt(container.dataset.year) || 2025;
          
          month--;
          if (month < 1) {
            month = 12;
            year--;
          }
          
          container.dataset.month = month;
          container.dataset.year = year;
          renderCalendar(container);
        });
      }
      
      // Next month button
      if (nextBtn) {
        nextBtn.addEventListener('click', function() {
          let month = parseInt(container.dataset.month) || 1;
          let year = parseInt(container.dataset.year) || 2025;
          
          month++;
          if (month > 12) {
            month = 1;
            year++;
          }
          
          container.dataset.month = month;
          container.dataset.year = year;
          renderCalendar(container);
        });
      }
      
      // Month dropdown
      if (monthSelect) {
        monthSelect.addEventListener('change', function() {
          const month = parseInt(this.value);
          container.dataset.month = month;
          renderCalendar(container);
        });
      }
      
      // Year dropdown - populate with more years if needed
      if (yearSelect) {
        const currentYear = new Date().getFullYear();
        const selectedYear = parseInt(yearSelect.value);
        const minYear = currentYear - 1;
        const maxYear = currentYear + 3;
        
        // Check if we need to add more years
        const existingYears = Array.from(yearSelect.options).map(opt => parseInt(opt.value));
        const needsMoreYears = selectedYear < minYear || selectedYear > maxYear;
        
        if (needsMoreYears) {
          // Clear and repopulate with wider range
          yearSelect.innerHTML = '';
          const startYear = Math.min(selectedYear, minYear) - 1;
          const endYear = Math.max(selectedYear, maxYear) + 1;
          for (let y = startYear; y <= endYear; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y;
            if (y === selectedYear) option.selected = true;
            yearSelect.appendChild(option);
          }
        }
        
        yearSelect.addEventListener('change', function() {
          const year = parseInt(this.value);
          container.dataset.year = year;
          renderCalendar(container);
        });
      }
      
      // Initial render
      renderCalendar(container);
    });
  })();
</script>

<style>
  .calendar-month-container {
    margin-bottom: 60px;
  }

  .calendar-month-container:last-child {
    margin-bottom: 0;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 20px;
  }

  .calendar-month-year-selector {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .calendar-month-select,
  .calendar-year-select {
    font-size: 1.5rem;
    font-weight: 600;
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 5px;
    outline: none;
  }

  .calendar-month-select:hover,
  .calendar-year-select:hover {
    opacity: 0.8;
  }

  .calendar-month-select:focus,
  .calendar-year-select:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
    border-radius: 2px;
  }

  .calendar-nav-arrow {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s ease, transform 0.2s ease;
    font-size: 1.5rem;
    min-width: 44px;
    min-height: 44px;
  }

  .calendar-nav-arrow:hover {
    opacity: 0.7;
    transform: scale(1.1);
  }

  .calendar-nav-arrow:active {
    transform: scale(0.95);
  }

  .calendar-nav-arrow svg {
    width: 24px;
    height: 24px;
  }

  .calendar-day {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .calendar-day:not(.empty):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* Event Details Modal */
  .event-details-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .event-details-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .event-details-modal-content {
    position: relative;
    background: #FFFFFF;
    border-radius: 2px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 10001;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .event-details-modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #FFFFFF;
    font-size: 1.2rem;
    z-index: 10002;
    transition: background 0.3s ease;
  }

  .event-details-modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .event-details-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 30px;
  }

  .event-details-image-wrapper {
    width: 100%;
    height: 300px;
    overflow: hidden;
    border-radius: 2px;
  }

  .event-details-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 2px;
  }

  .event-details-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .event-details-title {
    font-size: 2rem;
    font-weight: 600;
    margin: 0;
    color: {{ heading_color }};
    font-family: {{ heading_font_family }};
  }

  .event-details-date {
    font-size: 1.2rem;
    color: #666666;
    margin: 0;
  }

  .event-details-description {
    font-size: 1rem;
    color: #333333;
    line-height: 1.6;
    margin: 10px 0;
  }

  .event-details-price {
    display: flex;
    align-items: baseline;
    gap: 5px;
    font-size: 1.5rem;
    font-weight: 600;
    color: {{ heading_color }};
    margin-top: 10px;
  }

  .price-label {
    font-size: 1rem;
    font-weight: 400;
  }

  .price-amount {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .price-currency {
    font-size: 1rem;
    font-weight: 400;
  }

  .event-details-booking-form {
    padding: 30px;
    background-color: #F8F7F5;
    border-top: 1px solid #e0e0e0;
  }

  .event-details-booking-form h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.5rem;
    font-weight: 600;
    color: {{ heading_color }};
    font-family: {{ heading_font_family }};
  }

  .booking-form .form-group {
    margin-bottom: 20px;
  }

  .booking-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333333;
  }

  .booking-form input[type="text"],
  .booking-form input[type="email"],
  .booking-form input[type="tel"],
  .booking-form textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
  }

  .booking-form input:focus,
  .booking-form textarea:focus {
    outline: none;
    border-color: {{ heading_color }};
  }

  .booking-form textarea {
    resize: vertical;
    min-height: 80px;
  }

  .btn-confirm-booking {
    width: 100%;
    padding: 16px 32px;
    background-color: {{ heading_color }};
    color: #FFFFFF;
    border: none;
    border-radius: 2px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 10px;
  }

  .btn-confirm-booking:hover {
    background-color: #6B5B4F;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-confirm-booking:active {
    transform: translateY(0);
  }

  .btn-confirm-booking:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-confirm-booking .btn-loading {
    display: inline-block;
  }

  @media (max-width: 768px) {
    .event-details-modal-content {
      max-width: 100%;
      max-height: 100vh;
      border-radius: 0;
    }

    .event-details-content {
      padding: 20px;
    }

    .event-details-image-wrapper {
      height: 200px;
    }

    .event-details-title {
      font-size: 1.5rem;
    }

    .event-details-booking-form {
      padding: 20px;
    }
  }

  @media (max-width: 768px) {
    .calendar-month-select,
    .calendar-year-select {
      font-size: 1.2rem;
    }
    
    .calendar-month-container {
      margin-bottom: 40px;
    }

    .calendar-nav-arrow {
      padding: 6px 8px;
      min-width: 36px;
      min-height: 36px;
    }

    .calendar-nav-arrow svg {
      width: 20px;
      height: 20px;
    }

    .calendar-month-year-selector {
      flex-direction: column;
      gap: 5px;
    }
  }
</style>

{% schema %}
{
  "name": "Booking Calendar",
  "tag": "section",
  "class": "section-booking-calendar",
  "settings": [
    {
      "type": "header",
      "content": "Booking Flow"
    },
    {
      "type": "text",
      "id": "confirmation_page_url",
      "label": "Booking Confirmation Page URL",
      "info": "URL to the booking confirmation page (e.g., /pages/booking-confirmation). Leave empty to use home page with query parameter."
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Padding Top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_horizontal",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Padding Horizontal",
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "range",
      "id": "months_gap",
      "min": 20,
      "max": 100,
      "step": 10,
      "unit": "px",
      "label": "Gap Between Months",
      "default": 60,
      "info": "Spacing between multiple month calendars"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#F8F7F5"
    },
    {
      "type": "header",
      "content": "Calendar Navigation"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Month Navigation",
      "default": true,
      "info": "Display previous/next month buttons"
    },
    {
      "type": "header",
      "content": "Calendar Styling"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#8B6F47"
    },
    {
      "type": "select",
      "id": "heading_font_family",
      "label": "Heading Font Family",
      "options": [
        {
          "value": "Playfair Display, serif",
          "label": "Playfair Display"
        },
        {
          "value": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
          "label": "Segoe UI"
        },
        {
          "value": "Arial, sans-serif",
          "label": "Arial"
        }
      ],
      "default": "Playfair Display, serif"
    },
    {
      "type": "header",
      "content": "Weekdays"
    },
    {
      "type": "color",
      "id": "weekday_color",
      "label": "Weekday Text Color",
      "default": "#8B6F47"
    },
    {
      "type": "select",
      "id": "weekday_font_family",
      "label": "Weekday Font Family",
      "options": [
        {
          "value": "Playfair Display, serif",
          "label": "Playfair Display"
        },
        {
          "value": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
          "label": "Segoe UI"
        },
        {
          "value": "Arial, sans-serif",
          "label": "Arial"
        }
      ],
      "default": "Playfair Display, serif"
    },
    {
      "type": "header",
      "content": "Day Numbers"
    },
    {
      "type": "color",
      "id": "day_number_color",
      "label": "Day Number Color",
      "default": "#333333"
    }
  ],
  "blocks": [
    {
      "type": "month",
      "name": "Month",
      "settings": [
        {
          "type": "text",
          "id": "month_date",
          "label": "Month Date",
          "default": "2025-11-01",
          "info": "Select the month to display. Format: YYYY-MM-DD (e.g., 2025-11-01). Click in this field and most browsers will show a calendar date picker. The day can be any day in that month - only the month and year are used."
        }
      ]
    },
    {
      "type": "event",
      "name": "Event",
      "settings": [
        {
          "type": "text",
          "id": "event_date",
          "label": "Event Date",
          "default": "2025-11-01",
          "info": "Select the exact date for this event. Format: YYYY-MM-DD (e.g., 2025-11-15). Click in this field and most browsers will show a calendar date picker to select the date visually."
        },
        {
          "type": "image_picker",
          "id": "event_image",
          "label": "Event Image",
          "info": "Image to display on this day"
        },
        {
          "type": "text",
          "id": "event_title",
          "label": "Event Title",
          "default": "Yoga Class",
          "info": "Title or description of the event"
        },
        {
          "type": "textarea",
          "id": "event_description",
          "label": "Event Description",
          "info": "Detailed description of the event (optional)"
        },
        {
          "type": "text",
          "id": "event_price",
          "label": "Event Price",
          "default": "0",
          "info": "Price for this event (e.g., 100.00). Set to 0 for free events."
        },
        {
          "type": "url",
          "id": "event_link",
          "label": "Event Link",
          "info": "Optional: External link for event details. If provided, users can access this link from the event modal."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Booking Calendar",
      "blocks": [
        {
          "type": "month",
          "settings": {
            "month_date": "2025-11-01"
          }
        },
        {
          "type": "month",
          "settings": {
            "month_date": "2025-12-01"
          }
        },
        {
          "type": "event",
          "settings": {
            "event_date": "2025-11-01",
            "event_title": "Yoga Class"
          }
        },
        {
          "type": "event",
          "settings": {
            "event_date": "2025-11-05",
            "event_title": "Pilates Session"
          }
        },
        {
          "type": "event",
          "settings": {
            "event_date": "2025-12-15",
            "event_title": "Yoga Class"
          }
        }
      ]
    }
  ]
}
{% endschema %}
