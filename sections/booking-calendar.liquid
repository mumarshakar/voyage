{% comment %}
  sections/booking-calendar.liquid
  A custom section to display a booking calendar with event images.
  Supports multiple months that can be added via blocks.
  This is for visual representation. Actual booking logic requires
  a Shopify app or external integration.
{% endcomment %}

{%- liquid
  assign section_bg_color = section.settings.background_color | default: '#F8F7F5'
  assign padding_top = section.settings.padding_top | default: 60
  assign padding_bottom = section.settings.padding_bottom | default: 60
  assign padding_horizontal = section.settings.padding_horizontal | default: 20
  assign margin_top = section.settings.margin_top | default: 0
  assign margin_bottom = section.settings.margin_bottom | default: 0
  assign heading_color = section.settings.heading_color | default: '#8B6F47'
  assign weekday_color = section.settings.weekday_color | default: '#8B6F47'
  assign day_number_color = section.settings.day_number_color | default: '#333333'
  assign heading_font_family = section.settings.heading_font_family | default: 'Playfair Display, serif'
  assign weekday_font_family = section.settings.weekday_font_family | default: 'Playfair Display, serif'
  assign months_gap = section.settings.months_gap | default: 60
-%}

<div class="booking-calendar-section"
     id="booking-calendar-{{ section.id }}"
     style="background-color: {{ section_bg_color }};
            padding-top: {{ padding_top }}px;
            padding-bottom: {{ padding_bottom }}px;
            padding-left: {{ padding_horizontal }}px;
            padding-right: {{ padding_horizontal }}px;
            margin-top: {{ margin_top }}px;
            margin-bottom: {{ margin_bottom }}px;">

  {% comment %} Collect all month blocks {% endcomment %}
  {% assign month_blocks = section.blocks | where: 'type', 'month' %}
  
  {% if month_blocks.size > 0 %}
    {% for month_block in month_blocks %}
      {%- liquid
        assign month_number = month_block.settings.month | default: 1
        assign year_number = month_block.settings.year | default: 2025
        assign month_key = month_number | append: '-' | append: year_number
      -%}
      
      <div class="calendar-month-container" 
           data-month="{{ month_number }}" 
           data-year="{{ year_number }}"
           data-block-id="{{ month_block.id }}"
           style="margin-bottom: {{ months_gap }}px;">
        
        <div class="calendar-header">
          <h2 class="calendar-month-year" 
              style="color: {{ heading_color }}; 
                     font-family: {{ heading_font_family }};
                     text-align: center;
                     width: 100%;">
            {%- liquid
              case month_number
                when 1
                  echo 'January'
                when 2
                  echo 'February'
                when 3
                  echo 'March'
                when 4
                  echo 'April'
                when 5
                  echo 'May'
                when 6
                  echo 'June'
                when 7
                  echo 'July'
                when 8
                  echo 'August'
                when 9
                  echo 'September'
                when 10
                  echo 'October'
                when 11
                  echo 'November'
                when 12
                  echo 'December'
                else
                  echo 'January'
              endcase
            -%} {{ year_number }}
          </h2>
        </div>

        <div class="calendar-weekdays" 
             style="color: {{ weekday_color }}; 
                    font-family: {{ weekday_font_family }};">
          <span>SU</span>
          <span>MO</span>
          <span>TU</span>
          <span>WE</span>
          <span>TH</span>
          <span>FR</span>
          <span>SA</span>
        </div>

        <div class="calendar-grid" 
             data-month="{{ month_number }}" 
             data-year="{{ year_number }}"
             data-block-id="{{ month_block.id }}">
          {% comment %} Calendar days will be populated by JavaScript {% endcomment %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    {% comment %} Fallback: Show current month if no months are configured {% endcomment %}
    {%- liquid
      assign current_month = 'now' | date: '%m'
      assign current_year = 'now' | date: '%Y'
      assign current_month_num = current_month | plus: 0
      assign current_year_num = current_year | plus: 0
    -%}
    <div class="calendar-month-container" 
         data-month="{{ current_month_num }}" 
         data-year="{{ current_year_num }}"
         style="margin-bottom: {{ months_gap }}px;">
      
      <div class="calendar-header">
        <h2 class="calendar-month-year" 
            style="color: {{ heading_color }}; 
                   font-family: {{ heading_font_family }};
                   text-align: center;
                   width: 100%;">
          {{ 'now' | date: '%B %Y' }}
        </h2>
      </div>

      <div class="calendar-weekdays" 
           style="color: {{ weekday_color }}; 
                  font-family: {{ weekday_font_family }};">
        <span>SU</span>
        <span>MO</span>
        <span>TU</span>
        <span>WE</span>
        <span>TH</span>
        <span>FR</span>
        <span>SA</span>
      </div>

      <div class="calendar-grid" 
           data-month="{{ current_month_num }}" 
           data-year="{{ current_year_num }}">
        {% comment %} Calendar days will be populated by JavaScript {% endcomment %}
      </div>
    </div>
  {% endif %}

  {% comment %} Event blocks - associate events with months via month/year {% endcomment %}
  {% for block in section.blocks %}
    {% if block.type == 'event' %}
      <div class="event-data" 
           data-event-month="{{ block.settings.event_month | default: 1 }}"
           data-event-year="{{ block.settings.event_year | default: 2025 }}"
           data-event-day="{{ block.settings.event_day }}"
           data-event-image="{{ block.settings.event_image | image_url: width: 400 }}"
           data-event-title="{{ block.settings.event_title | escape }}"
           data-event-link="{{ block.settings.event_link }}"
           style="display: none;">
      </div>
    {% endif %}
  {% endfor %}

</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const calendarSection = document.getElementById('booking-calendar-{{ section.id }}');
    if (!calendarSection) return;

    // Collect all event data by month-year-day key
    const eventData = {};
    const eventDivs = calendarSection.querySelectorAll('.event-data');
    eventDivs.forEach(div => {
      const month = parseInt(div.dataset.eventMonth) || 1;
      const year = parseInt(div.dataset.eventYear) || 2025;
      const day = parseInt(div.dataset.eventDay);
      if (day) {
        const key = `${year}-${month}-${day}`;
        eventData[key] = {
          image: div.dataset.eventImage,
          title: div.dataset.eventTitle,
          link: div.dataset.eventLink
        };
      }
    });

    // Render calendar for a specific month
    function renderCalendar(monthContainer) {
      const calendarGrid = monthContainer.querySelector('.calendar-grid');
      if (!calendarGrid) return;

      const month = parseInt(monthContainer.dataset.month) || 1;
      const year = parseInt(monthContainer.dataset.year) || 2025;

      // Clear existing days
      calendarGrid.innerHTML = '';

      // Calculate first day of month and days in month
      const firstDayOfMonth = new Date(year, month - 1, 1);
      const lastDayOfMonth = new Date(year, month, 0);
      const daysInMonth = lastDayOfMonth.getDate();
      const startDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sunday, 1 = Monday, etc.

      // Add empty leading days
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('calendar-day', 'empty');
        calendarGrid.appendChild(emptyDay);
      }

      // Add actual days
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('calendar-day');
        
        const dayNumber = document.createElement('span');
        dayNumber.classList.add('day-number');
        dayNumber.style.color = '{{ day_number_color }}';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);

        // Check if this day has an event
        const eventKey = `${year}-${month}-${day}`;
        if (eventData[eventKey]) {
          dayElement.classList.add('has-event');
          const eventInfo = eventData[eventKey];
          
          const imgWrapper = document.createElement('div');
          imgWrapper.classList.add('event-image-wrapper');
          const img = document.createElement('img');
          img.src = eventInfo.image;
          img.alt = eventInfo.title || 'Event';
          img.loading = 'lazy';
          img.width = '400';
          img.height = '300';
          imgWrapper.appendChild(img);
          dayElement.appendChild(imgWrapper);

          // Make clickable if link is provided
          if (eventInfo.link) {
            dayElement.style.cursor = 'pointer';
            dayElement.addEventListener('click', function() {
              window.location.href = eventInfo.link;
            });
          }
        }

        calendarGrid.appendChild(dayElement);
      }

      // Fill remaining empty cells to complete grid
      const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
      const remainingCells = totalCells - (startDayOfWeek + daysInMonth);
      for (let i = 0; i < remainingCells; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.classList.add('calendar-day', 'empty');
        calendarGrid.appendChild(emptyDay);
      }
    }

    // Render all month calendars
    const monthContainers = calendarSection.querySelectorAll('.calendar-month-container');
    monthContainers.forEach(container => {
      renderCalendar(container);
    });
  })();
</script>

<style>
  .calendar-month-container {
    margin-bottom: 60px;
  }

  .calendar-month-container:last-child {
    margin-bottom: 0;
  }

  .calendar-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
  }

  .calendar-month-year {
    margin: 0;
    font-size: 2rem;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .calendar-month-year {
      font-size: 1.5rem;
    }
    
    .calendar-month-container {
      margin-bottom: 40px;
    }
  }
</style>

{% schema %}
{
  "name": "Booking Calendar",
  "tag": "section",
  "class": "section-booking-calendar",
  "settings": [
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Padding Top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_horizontal",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Padding Horizontal",
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "range",
      "id": "months_gap",
      "min": 20,
      "max": 100,
      "step": 10,
      "unit": "px",
      "label": "Gap Between Months",
      "default": 60,
      "info": "Spacing between multiple month calendars"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#F8F7F5"
    },
    {
      "type": "header",
      "content": "Calendar Styling"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#8B6F47"
    },
    {
      "type": "select",
      "id": "heading_font_family",
      "label": "Heading Font Family",
      "options": [
        {
          "value": "Playfair Display, serif",
          "label": "Playfair Display"
        },
        {
          "value": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
          "label": "Segoe UI"
        },
        {
          "value": "Arial, sans-serif",
          "label": "Arial"
        }
      ],
      "default": "Playfair Display, serif"
    },
    {
      "type": "header",
      "content": "Weekdays"
    },
    {
      "type": "color",
      "id": "weekday_color",
      "label": "Weekday Text Color",
      "default": "#8B6F47"
    },
    {
      "type": "select",
      "id": "weekday_font_family",
      "label": "Weekday Font Family",
      "options": [
        {
          "value": "Playfair Display, serif",
          "label": "Playfair Display"
        },
        {
          "value": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
          "label": "Segoe UI"
        },
        {
          "value": "Arial, sans-serif",
          "label": "Arial"
        }
      ],
      "default": "Playfair Display, serif"
    },
    {
      "type": "header",
      "content": "Day Numbers"
    },
    {
      "type": "color",
      "id": "day_number_color",
      "label": "Day Number Color",
      "default": "#333333"
    }
  ],
  "blocks": [
    {
      "type": "month",
      "name": "Month",
      "settings": [
        {
          "type": "range",
          "id": "month",
          "min": 1,
          "max": 12,
          "step": 1,
          "label": "Month",
          "default": 11,
          "info": "Month number (1 = January, 12 = December)"
        },
        {
          "type": "number",
          "id": "year",
          "label": "Year",
          "default": 2025,
          "info": "Year (e.g., 2025)"
        }
      ]
    },
    {
      "type": "event",
      "name": "Event",
      "settings": [
        {
          "type": "range",
          "id": "event_month",
          "min": 1,
          "max": 12,
          "step": 1,
          "label": "Event Month",
          "default": 11,
          "info": "Month when this event occurs (1 = January, 12 = December)"
        },
        {
          "type": "number",
          "id": "event_year",
          "label": "Event Year",
          "default": 2025,
          "info": "Year when this event occurs (e.g., 2025)"
        },
        {
          "type": "range",
          "id": "event_day",
          "min": 1,
          "max": 31,
          "step": 1,
          "label": "Event Day",
          "default": 1,
          "info": "Day of month (1-31) when this event occurs"
        },
        {
          "type": "image_picker",
          "id": "event_image",
          "label": "Event Image",
          "info": "Image to display on this day"
        },
        {
          "type": "text",
          "id": "event_title",
          "label": "Event Title",
          "default": "Yoga Class",
          "info": "Alt text for the image"
        },
        {
          "type": "url",
          "id": "event_link",
          "label": "Event Link",
          "info": "Optional: Link when clicking on the event day"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Booking Calendar",
      "blocks": [
        {
          "type": "month",
          "settings": {
            "month": 11,
            "year": 2025
          }
        },
        {
          "type": "month",
          "settings": {
            "month": 12,
            "year": 2025
          }
        },
        {
          "type": "event",
          "settings": {
            "event_month": 11,
            "event_year": 2025,
            "event_day": 1,
            "event_title": "Yoga Class"
          }
        },
        {
          "type": "event",
          "settings": {
            "event_month": 11,
            "event_year": 2025,
            "event_day": 5,
            "event_title": "Pilates Session"
          }
        },
        {
          "type": "event",
          "settings": {
            "event_month": 12,
            "event_year": 2025,
            "event_day": 15,
            "event_title": "Yoga Class"
          }
        }
      ]
    }
  ]
}
{% endschema %}
