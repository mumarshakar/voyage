{% schema %}
{
  "name": "Image Carousel",
  "settings": [
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay Speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "info": "Time between slides when autoplay is enabled"
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Loop Carousel",
      "default": true,
      "info": "When enabled, carousel will loop from last to first slide"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Dot Indicators",
      "default": true,
      "info": "Show dots below carousel to indicate current slide"
    },
    {
      "type": "select",
      "id": "transition_effect",
      "label": "Transition Effect",
      "options": [
        {
          "value": "slide",
          "label": "Slide"
        },
        {
          "value": "fade",
          "label": "Fade"
        }
      ],
      "default": "slide"
    },
    {
      "type": "range",
      "id": "transition_speed",
      "label": "Transition Speed (ms)",
      "min": 300,
      "max": 1000,
      "step": 100,
      "default": 500,
      "unit": "ms"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "images_per_view",
      "label": "Images Per View",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 3,
      "info": "Number of images visible at once"
    },
    {
      "type": "range",
      "id": "image_height",
      "label": "Image Height (px)",
      "min": 300,
      "max": 1000,
      "step": 50,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "image_gap",
      "label": "Gap Between Images (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "Image Fit",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        }
      ],
      "default": "cover"
    },
    {
      "type": "range",
      "id": "arrows_size",
      "label": "Arrow Size (px)",
      "min": 30,
      "max": 80,
      "step": 5,
      "default": 50,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "arrows_color",
      "label": "Arrows Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "arrows_bg_color",
      "label": "Arrows Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "arrows_opacity",
      "label": "Arrows Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "%"
    },
    {
      "type": "color",
      "id": "dots_color",
      "label": "Dots Active Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "dots_inactive_color",
      "label": "Dots Inactive Color",
      "default": "#CCCCCC"
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Section Background Color",
      "default": "#EAE7E1"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section Top Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section Bottom Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_horizontal",
      "label": "Section Horizontal Padding (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt Text",
          "info": "Image description for accessibility"
        },
        {
          "type": "url",
          "id": "image_link",
          "label": "Image Link",
          "info": "Optional: Make image clickable"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Carousel",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}

{%- liquid
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed | default: 5
  assign loop = section.settings.loop
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign transition_effect = section.settings.transition_effect | default: 'slide'
  assign transition_speed = section.settings.transition_speed | default: 500
  assign images_per_view = section.settings.images_per_view | default: 3
  assign image_height = section.settings.image_height | default: 600
  assign image_fit = section.settings.image_fit | default: 'cover'
  assign image_gap = section.settings.image_gap | default: 15
  assign arrows_size = section.settings.arrows_size | default: 50
  assign arrows_color = section.settings.arrows_color | default: '#8B6F47'
  assign arrows_bg_color = section.settings.arrows_bg_color | default: '#FFFFFF'
  assign arrows_opacity = section.settings.arrows_opacity | default: 90
  assign dots_color = section.settings.dots_color | default: '#8B6F47'
  assign dots_inactive_color = section.settings.dots_inactive_color | default: '#CCCCCC'
  assign section_bg_color = section.settings.section_bg_color | default: '#EAE7E1'
  assign section_padding_top = section.settings.section_padding_top | default: 80
  assign section_padding_bottom = section.settings.section_padding_bottom | default: 80
  assign section_padding_horizontal = section.settings.section_padding_horizontal | default: 20
  
  assign arrows_opacity_decimal = arrows_opacity | divided_by: 100.0
  assign autoplay_interval = autoplay_speed | times: 1000
-%}

<section class="image-carousel-section" 
         id="carousel-{{ section.id }}"
         style="background-color: {{ section_bg_color }};
                padding-top: {{ section_padding_top }}px;
                padding-bottom: {{ section_padding_bottom }}px;
                padding-left: {{ section_padding_horizontal }}px;
                padding-right: {{ section_padding_horizontal }}px;">
  
  <div class="container">
    <div class="image-carousel-wrapper" 
         data-autoplay="{{ autoplay }}"
         data-autoplay-speed="{{ autoplay_interval }}"
         data-loop="{{ loop }}"
         data-transition="{{ transition_effect }}"
         data-transition-speed="{{ transition_speed }}"
         data-images-per-view="{{ images_per_view }}">
      
      <div class="image-carousel-container" 
           style="display: flex;
                  gap: {{ image_gap }}px;
                  overflow: hidden;
                  position: relative;">
        {% if section.blocks.size > 0 %}
          {% for block in section.blocks %}
            {% assign slide_width = 100 | divided_by: images_per_view | minus: 1 %}
            <div class="carousel-slide {% if forloop.index <= images_per_view %}active{% endif %}" 
                 data-slide-index="{{ forloop.index0 }}"
                 style="flex: 0 0 calc((100% - {{ image_gap | times: images_per_view | minus: image_gap }}px) / {{ images_per_view }});
                        min-width: 0;
                        transition: transform {{ transition_speed }}ms ease-in-out,
                                   opacity {{ transition_speed }}ms ease-in-out;
                        {% if forloop.index > images_per_view %}opacity: 0; transform: translateX(100%);{% endif %}"
                 {{ block.shopify_attributes }}>
              {% if block.settings.image != blank %}
                {% if block.settings.image_link != blank %}
                  <a href="{{ block.settings.image_link }}" class="carousel-image-link">
                {% endif %}
                <img src="{{ block.settings.image | img_url: '1920x1080' }}" 
                     alt="{{ block.settings.alt_text | escape }}"
                     class="carousel-image"
                     loading="lazy"
                     style="width: 100%;
                            height: {{ image_height }}px;
                            object-fit: {{ image_fit }};
                            display: block;
                            border-radius: 8px;">
                {% if block.settings.image_link != blank %}
                  </a>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      {% if show_arrows and section.blocks.size > images_per_view %}
        <button class="carousel-arrow carousel-arrow-prev" 
                aria-label="Previous slide"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="carousel-arrow carousel-arrow-next" 
                aria-label="Next slide"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      {% endif %}
      
      {% if show_dots and section.blocks.size > images_per_view %}
        <div class="carousel-dots">
          {% assign total_groups = section.blocks.size | divided_by: images_per_view | ceil %}
          {% for i in (1..total_groups) %}
            <button class="carousel-dot {% if forloop.first %}active{% endif %}" 
                    data-dot-index="{{ forloop.index0 }}"
                    aria-label="Go to group {{ forloop.index }}"
                    style="background-color: {% if forloop.first %}{{ dots_color }}{% else %}{{ dots_inactive_color }}{% endif %};">
            </button>
          {% endfor %}
        </div>
      {% endif %}
      
    </div>
  </div>
</section>

<style>
  .image-carousel-section {
    position: relative;
  }
  
  .image-carousel-wrapper {
    position: relative;
    width: 100%;
  }
  
  .image-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 8px;
  }
  
  .carousel-slide {
    opacity: 0;
    transform: translateX(100%);
  }
  
  .carousel-slide.active {
    opacity: 1;
    transform: translateX(0);
  }
  
  .carousel-image {
    width: 100%;
    display: block;
  }
  
  .carousel-image-link {
    display: block;
    width: 100%;
    height: 100%;
  }
  
  .carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    border: 2px solid;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
  }
  
  .carousel-arrow:hover {
    opacity: 1 !important;
    transform: translateY(-50%) scale(1.1);
  }
  
  .carousel-arrow:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  .carousel-arrow-prev {
    left: 20px;
  }
  
  .carousel-arrow-next {
    right: 20px;
  }
  
  .carousel-arrow svg {
    width: 60%;
    height: 60%;
  }
  
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    padding: 0;
  }
  
  .carousel-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
    background-color: {{ dots_inactive_color }};
  }
  
  .carousel-dot.active {
    background-color: {{ dots_color }};
    transform: scale(1.2);
  }
  
  .carousel-dot:hover {
    transform: scale(1.3);
    opacity: 0.8;
  }
  
  @media (max-width: 767px) {
    .carousel-arrow-prev {
      left: 10px;
    }
    
    .carousel-arrow-next {
      right: 10px;
    }
    
    .carousel-arrow {
      width: 40px !important;
      height: 40px !important;
    }
  }
</style>

<script>
  (function() {
    const carousel = document.getElementById('carousel-{{ section.id }}');
    if (!carousel) return;
    
    const wrapper = carousel.querySelector('.image-carousel-wrapper');
    const container = carousel.querySelector('.image-carousel-container');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.querySelectorAll('.carousel-dot');
    const prevArrow = carousel.querySelector('.carousel-arrow-prev');
    const nextArrow = carousel.querySelector('.carousel-arrow-next');
    
    if (slides.length <= 1) return;
    
    const autoplay = wrapper.dataset.autoplay === 'true';
    const autoplaySpeed = parseInt(wrapper.dataset.autoplaySpeed) || 5000;
    const loop = wrapper.dataset.loop === 'true';
    const transitionSpeed = parseInt(wrapper.dataset.transitionSpeed) || 500;
    
    // Get images per view from data attribute or default to 3
    const imagesPerView = parseInt(wrapper.dataset.imagesPerView) || 3;
    const totalSlides = slides.length;
    const totalGroups = Math.ceil(totalSlides / imagesPerView);
    
    let currentGroup = 0;
    let autoplayInterval = null;
    
    function showGroup(groupIndex) {
      // Calculate which slides to show
      const startIndex = groupIndex * imagesPerView;
      const endIndex = Math.min(startIndex + imagesPerView, totalSlides);
      
      // Remove active classes
      slides.forEach((slide, index) => {
        if (index >= startIndex && index < endIndex) {
          slide.classList.add('active');
        } else {
          slide.classList.remove('active');
        }
      });
      
      // Update dots
      dots.forEach((dot, index) => {
        if (index === groupIndex) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
      
      currentGroup = groupIndex;
      
      // Update arrow states
      if (!loop) {
        if (prevArrow) prevArrow.style.opacity = groupIndex === 0 ? '0.3' : '1';
        if (nextArrow) nextArrow.style.opacity = groupIndex >= totalGroups - 1 ? '0.3' : '1';
      }
    }
    
    function nextGroup() {
      if (currentGroup < totalGroups - 1) {
        showGroup(currentGroup + 1);
      } else if (loop) {
        showGroup(0);
      }
    }
    
    function prevGroup() {
      if (currentGroup > 0) {
        showGroup(currentGroup - 1);
      } else if (loop) {
        showGroup(totalGroups - 1);
      }
    }
    
    function startAutoplay() {
      if (autoplay) {
        autoplayInterval = setInterval(nextGroup, autoplaySpeed);
      }
    }
    
    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    }
    
    // Event listeners
    if (nextArrow) {
      nextArrow.addEventListener('click', () => {
        nextGroup();
        stopAutoplay();
        startAutoplay();
      });
    }
    
    if (prevArrow) {
      prevArrow.addEventListener('click', () => {
        prevGroup();
        stopAutoplay();
        startAutoplay();
      });
    }
    
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showGroup(index);
        stopAutoplay();
        startAutoplay();
      });
    });
    
    // Pause on hover
    wrapper.addEventListener('mouseenter', stopAutoplay);
    wrapper.addEventListener('mouseleave', startAutoplay);
    
    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;
    
    wrapper.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });
    
    wrapper.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });
    
    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          nextGroup();
        } else {
          prevGroup();
        }
        stopAutoplay();
        startAutoplay();
      }
    }
    
    // Initialize
    showGroup(0);
    startAutoplay();
  })();
</script>

