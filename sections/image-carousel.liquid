{% schema %}
{
  "name": "Image Carousel",
  "max_blocks": 15,
  "settings": [
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay Speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 10,
      "unit": "s",
      "info": "Controls scroll speed - lower values = faster scrolling"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Dot Indicators",
      "default": true,
      "info": "Show dots below carousel to indicate current slide"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "images_per_view",
      "label": "Images Per View",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 3,
      "info": "Number of images visible at once"
    },
    {
      "type": "range",
      "id": "image_height",
      "label": "Image Height (px)",
      "min": 300,
      "max": 1000,
      "step": 50,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "image_gap",
      "label": "Gap Between Images (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "Image Fit",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        }
      ],
      "default": "cover"
    },
    {
      "type": "range",
      "id": "arrows_size",
      "label": "Arrow Size (px)",
      "min": 30,
      "max": 80,
      "step": 5,
      "default": 50,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "arrows_color",
      "label": "Arrows Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "arrows_bg_color",
      "label": "Arrows Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "arrows_opacity",
      "label": "Arrows Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "%"
    },
    {
      "type": "color",
      "id": "dots_color",
      "label": "Dots Active Color",
      "default": "#8B6F47"
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Section Background Color",
      "default": "#EAE7E1"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section Top Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section Bottom Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_horizontal",
      "label": "Section Horizontal Padding (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Carousel Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt Text",
          "info": "Image description for accessibility"
        },
        {
          "type": "url",
          "id": "image_link",
          "label": "Image Link",
          "info": "Optional: Make image clickable"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Carousel",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}

{%- liquid
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed | default: 5
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign images_per_view = section.settings.images_per_view | default: 3
  assign image_height = section.settings.image_height | default: 600
  assign image_fit = section.settings.image_fit | default: 'cover'
  assign image_gap = section.settings.image_gap | default: 15
  assign arrows_size = section.settings.arrows_size | default: 50
  assign arrows_color = section.settings.arrows_color | default: '#8B6F47'
  assign arrows_bg_color = section.settings.arrows_bg_color | default: '#FFFFFF'
  assign arrows_opacity = section.settings.arrows_opacity | default: 90
  assign dots_color = section.settings.dots_color | default: '#8B6F47'
  assign section_bg_color = section.settings.section_bg_color | default: '#EAE7E1'
  assign section_padding_top = section.settings.section_padding_top | default: 80
  assign section_padding_bottom = section.settings.section_padding_bottom | default: 80
  assign section_padding_horizontal = section.settings.section_padding_horizontal | default: 20
  
  assign arrows_opacity_decimal = arrows_opacity | divided_by: 100.0
  assign autoplay_interval = autoplay_speed | times: 1000
-%}

<section class="image-carousel-section" 
         id="carousel-{{ section.id }}"
         style="background-color: {{ section_bg_color }};
                padding-top: {{ section_padding_top }}px;
                padding-bottom: {{ section_padding_bottom }}px;
                padding-left: {{ section_padding_horizontal }}px;
                padding-right: {{ section_padding_horizontal }}px;">
  
  <div class="container">
    <div class="image-carousel-wrapper" 
         data-autoplay="{{ autoplay }}"
         data-scroll-speed="{{ autoplay_interval }}"
         data-images-per-view="{{ images_per_view }}">
      
      <div class="image-carousel-container" 
           style="overflow: hidden;
                  position: relative;">
        {% if section.blocks.size > 0 %}
          <div class="carousel-track" 
               data-autoplay="{{ autoplay }}"
               data-scroll-speed="{{ autoplay_interval }}"
               style="display: flex;
                      gap: {{ image_gap }}px;
                      will-change: transform;">
            {% for block in section.blocks %}
              <div class="carousel-slide" 
                   data-slide-index="{{ forloop.index0 }}"
                   style="flex: 0 0 calc((100% - {{ image_gap | times: images_per_view | minus: image_gap }}px) / {{ images_per_view }});
                          min-width: 0;"
                   {{ block.shopify_attributes }}>
                {% if block.settings.image != blank %}
                  {% if block.settings.image_link != blank %}
                    <a href="{{ block.settings.image_link }}" class="carousel-image-link">
                  {% endif %}
                  <img src="{{ block.settings.image | image_url: width: 1920 }}" 
                       alt="{{ block.settings.alt_text | escape }}"
                       class="carousel-image"
                       width="1920"
                       height="{{ image_height }}"
                       loading="lazy"
                       style="width: 100%;
                              height: {{ image_height }}px;
                              object-fit: {{ image_fit }};
                              display: block;
                              border-radius: 2px;">
                  {% if block.settings.image_link != blank %}
                    </a>
                  {% endif %}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      
      {% if show_arrows %}
        <button class="carousel-arrow carousel-arrow-prev" 
                aria-label="Previous view"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="carousel-arrow carousel-arrow-next" 
                aria-label="Next view"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      {% endif %}
      
      {% if show_dots %}
        <div class="carousel-dots">
          <button class="carousel-dot carousel-dot-pause" 
                  aria-label="Pause/Play carousel"
                  style="background-color: {{ dots_color }};"
                  title="Pause/Play">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>
        </div>
      {% endif %}
      
    </div>
  </div>
</section>

<style>
  .image-carousel-section {
    position: relative;
  }
  
  .image-carousel-wrapper {
    position: relative;
    width: 100%;
  }
  
  .image-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 2px;
  }
  
  .carousel-track {
    transition: transform 0.6s ease-in-out;
  }
  
  .carousel-track.paused {
    transition: none;
  }
  
  .carousel-image {
    width: 100%;
    display: block;
  }
  
  .carousel-image-link {
    display: block;
    width: 100%;
    height: 100%;
  }
  
  .carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    border: 2px solid;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
  }
  
  .carousel-arrow:hover {
    opacity: 1 !important;
    transform: translateY(-50%) scale(1.1);
  }
  
  .carousel-arrow:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  .carousel-arrow-prev {
    left: 20px;
  }
  
  .carousel-arrow-next {
    right: 20px;
  }
  
  .carousel-arrow svg {
    width: 60%;
    height: 60%;
  }
  
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    padding: 0;
  }
  
  .carousel-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid {{ dots_color }};
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
    background-color: {{ arrows_bg_color }};
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ dots_color }};
  }
  
  .carousel-dot:hover {
    transform: scale(1.1);
    opacity: 0.9;
  }
  
  .carousel-dot svg {
    width: 16px;
    height: 16px;
  }
  
  @media (max-width: 767px) {
    .carousel-arrow-prev {
      left: 10px;
    }
    
    .carousel-arrow-next {
      right: 10px;
    }
    
    .carousel-arrow {
      width: 40px !important;
      height: 40px !important;
    }
    
    .carousel-dot {
      width: 36px;
      height: 36px;
    }
    
    /* Show 1 image per view on mobile */
    .carousel-slide {
      flex: 0 0 calc(100% - 10px) !important;
    }
  }
  
  @media (min-width: 768px) and (max-width: 1023px) {
    /* Show 2 images per view on tablet */
    .carousel-slide {
      flex: 0 0 calc((100% - 15px) / 2) !important;
    }
  }
</style>

<script>
  (function() {
    const carousel = document.getElementById('carousel-{{ section.id }}');
    if (!carousel) return;
    
    const wrapper = carousel.querySelector('.image-carousel-wrapper');
    const container = carousel.querySelector('.image-carousel-container');
    const track = carousel.querySelector('.carousel-track');
    const pauseDot = carousel.querySelector('.carousel-dot-pause');
    const prevArrow = carousel.querySelector('.carousel-arrow-prev');
    const nextArrow = carousel.querySelector('.carousel-arrow-next');
    const originalSlides = Array.from(carousel.querySelectorAll('.carousel-slide'));
    
    if (!wrapper || !container || !track || originalSlides.length === 0) return;
    
    const autoplay = wrapper.dataset.autoplay === 'true';
    const baseImagesPerView = parseInt(wrapper.dataset.imagesPerView, 10) || 3;
    const PAUSE_DURATION = 3000;
    const SCROLL_DURATION = 600;
    const SCROLL_STEP = 1;
    const TRANSITION_STYLE = `transform ${SCROLL_DURATION}ms ease-in-out`;
    
    let currentImagesPerView = 1;
    let currentSlideWidth = container.offsetWidth;
    let currentSlideIndex = 0;
    let currentCloneCount = 0;
    let isPaused = false;
    let autoplayTimer = null;
    let normalizeTimer = null;
    let resizeTimeout;
    
    function getResponsiveImagesPerView() {
      const width = window.innerWidth;
      if (width <= 767) {
        return 1;
      }
      if (width <= 1023) {
        return Math.min(2, baseImagesPerView);
      }
      return baseImagesPerView;
    }
    
    function measureSlideWidth() {
      const referenceSlide = originalSlides[0];
      if (!referenceSlide) {
        return container.offsetWidth;
      }
      const rect = referenceSlide.getBoundingClientRect();
      const trackStyles = window.getComputedStyle(track);
      const gap = parseFloat(trackStyles.columnGap || trackStyles.gap || 0) || 0;
      return rect.width + gap;
    }
    
    function applyTransform(animate = true) {
      if (!animate) {
        track.style.transition = 'none';
        track.style.transform = `translateX(-${currentSlideIndex * currentSlideWidth}px)`;
        // Force reflow so the transition can be reapplied cleanly
        track.offsetHeight;
        track.style.transition = TRANSITION_STYLE;
        return;
      }
      
      track.style.transition = TRANSITION_STYLE;
      track.style.transform = `translateX(-${currentSlideIndex * currentSlideWidth}px)`;
    }
    
    function normalizeIndex() {
      if (currentCloneCount === 0) return;
      
      const minIndex = currentCloneCount;
      const maxIndex = currentCloneCount + originalSlides.length - 1;
      
      if (currentSlideIndex > maxIndex) {
        currentSlideIndex = minIndex;
        applyTransform(false);
      } else if (currentSlideIndex < minIndex) {
        currentSlideIndex = maxIndex;
        applyTransform(false);
      }
    }
    
    function scheduleNormalize() {
      clearTimeout(normalizeTimer);
      normalizeTimer = setTimeout(() => {
        normalizeIndex();
      }, SCROLL_DURATION);
    }
    
    function canAdvance() {
      return originalSlides.length > 1;
    }
    
    function nextSlide(step = SCROLL_STEP) {
      if (!canAdvance()) return;
      currentSlideIndex += step;
      applyTransform(true);
      scheduleNormalize();
    }
    
    function prevSlide(step = SCROLL_STEP) {
      if (!canAdvance()) return;
      currentSlideIndex -= step;
      applyTransform(true);
      scheduleNormalize();
    }
    
    function stopAutoplay() {
      if (autoplayTimer) {
        clearTimeout(autoplayTimer);
        autoplayTimer = null;
      }
    }
    
    function startAutoplay(initialDelay = PAUSE_DURATION) {
      if (!autoplay || isPaused || !canAdvance()) return;
      stopAutoplay();
      
      const advance = () => {
        if (isPaused) return;
        nextSlide();
        stopAutoplay();
        autoplayTimer = setTimeout(advance, PAUSE_DURATION + SCROLL_DURATION);
      };
      
      autoplayTimer = setTimeout(advance, initialDelay);
    }
    
    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        track.classList.add('paused');
        stopAutoplay();
      } else {
        track.classList.remove('paused');
        startAutoplay(PAUSE_DURATION);
      }
    }
    
    function setupTrackStructure() {
      // Remove any existing clones before rebuilding
      track.querySelectorAll('.carousel-slide-clone').forEach(clone => clone.remove());
      
      currentImagesPerView = getResponsiveImagesPerView();
      const totalRealSlides = originalSlides.length;
      currentCloneCount = totalRealSlides > 1 ? Math.min(currentImagesPerView, totalRealSlides) : 0;
      
      if (currentCloneCount > 0) {
        const leadingClones = originalSlides.slice(-currentCloneCount);
        leadingClones.forEach(slide => {
          const clone = slide.cloneNode(true);
          clone.classList.add('carousel-slide-clone');
          track.insertBefore(clone, track.firstChild);
        });
        
        const trailingClones = originalSlides.slice(0, currentCloneCount);
        trailingClones.forEach(slide => {
          const clone = slide.cloneNode(true);
          clone.classList.add('carousel-slide-clone');
          track.appendChild(clone);
        });
      }
      
      currentSlideWidth = measureSlideWidth();
      currentSlideIndex = currentCloneCount > 0 ? currentCloneCount : 0;
      applyTransform(false);
    }
    
    function rebuildTrack() {
      const shouldResumeAutoplay = autoplay && !isPaused;
      stopAutoplay();
      setupTrackStructure();
      if (shouldResumeAutoplay) {
        startAutoplay(PAUSE_DURATION);
      }
    }
    
    if (pauseDot) {
      pauseDot.addEventListener('click', togglePause);
    }
    
    if (prevArrow) {
      prevArrow.addEventListener('click', () => {
        stopAutoplay();
        prevSlide();
        if (autoplay && !isPaused) {
          startAutoplay(PAUSE_DURATION);
        }
      });
    }
    
    if (nextArrow) {
      nextArrow.addEventListener('click', () => {
        stopAutoplay();
        nextSlide();
        if (autoplay && !isPaused) {
          startAutoplay(PAUSE_DURATION);
        }
      });
    }
    
    if (autoplay) {
      wrapper.addEventListener('mouseenter', () => {
        if (!isPaused) {
          track.classList.add('paused');
          stopAutoplay();
        }
      });
      
      wrapper.addEventListener('mouseleave', () => {
        if (!isPaused) {
          track.classList.remove('paused');
          startAutoplay(PAUSE_DURATION);
        }
      });
    }
    
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        rebuildTrack();
      }, 250);
    });
    
    // Initialize
    rebuildTrack();
    if (autoplay) {
      startAutoplay(PAUSE_DURATION);
    } else {
      isPaused = true;
      track.classList.add('paused');
    }
  })();
</script>


