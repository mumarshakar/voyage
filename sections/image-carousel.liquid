{% schema %}
{
  "name": "Image Carousel",
  "settings": [
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay Speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "info": "Controls scroll speed - lower values = faster scrolling"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Dot Indicators",
      "default": true,
      "info": "Show dots below carousel to indicate current slide"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "images_per_view",
      "label": "Images Per View",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 3,
      "info": "Number of images visible at once"
    },
    {
      "type": "range",
      "id": "image_height",
      "label": "Image Height (px)",
      "min": 300,
      "max": 1000,
      "step": 50,
      "default": 600,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "image_gap",
      "label": "Gap Between Images (px)",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "Image Fit",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        }
      ],
      "default": "cover"
    },
    {
      "type": "range",
      "id": "arrows_size",
      "label": "Arrow Size (px)",
      "min": 30,
      "max": 80,
      "step": 5,
      "default": 50,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "arrows_color",
      "label": "Arrows Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "arrows_bg_color",
      "label": "Arrows Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "arrows_opacity",
      "label": "Arrows Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 90,
      "unit": "%"
    },
    {
      "type": "color",
      "id": "dots_color",
      "label": "Dots Active Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "dots_inactive_color",
      "label": "Dots Inactive Color",
      "default": "#CCCCCC"
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Section Background Color",
      "default": "#EAE7E1"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section Top Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section Bottom Padding (px)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding_horizontal",
      "label": "Section Horizontal Padding (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Carousel Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt Text",
          "info": "Image description for accessibility"
        },
        {
          "type": "url",
          "id": "image_link",
          "label": "Image Link",
          "info": "Optional: Make image clickable"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Carousel",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}

{%- liquid
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed | default: 5
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign images_per_view = section.settings.images_per_view | default: 3
  assign image_height = section.settings.image_height | default: 600
  assign image_fit = section.settings.image_fit | default: 'cover'
  assign image_gap = section.settings.image_gap | default: 15
  assign arrows_size = section.settings.arrows_size | default: 50
  assign arrows_color = section.settings.arrows_color | default: '#8B6F47'
  assign arrows_bg_color = section.settings.arrows_bg_color | default: '#FFFFFF'
  assign arrows_opacity = section.settings.arrows_opacity | default: 90
  assign dots_color = section.settings.dots_color | default: '#8B6F47'
  assign dots_inactive_color = section.settings.dots_inactive_color | default: '#CCCCCC'
  assign section_bg_color = section.settings.section_bg_color | default: '#EAE7E1'
  assign section_padding_top = section.settings.section_padding_top | default: 80
  assign section_padding_bottom = section.settings.section_padding_bottom | default: 80
  assign section_padding_horizontal = section.settings.section_padding_horizontal | default: 20
  
  assign arrows_opacity_decimal = arrows_opacity | divided_by: 100.0
  assign autoplay_interval = autoplay_speed | times: 1000
-%}

<section class="image-carousel-section" 
         id="carousel-{{ section.id }}"
         style="background-color: {{ section_bg_color }};
                padding-top: {{ section_padding_top }}px;
                padding-bottom: {{ section_padding_bottom }}px;
                padding-left: {{ section_padding_horizontal }}px;
                padding-right: {{ section_padding_horizontal }}px;">
  
  <div class="container">
    <div class="image-carousel-wrapper" 
         data-autoplay="{{ autoplay }}"
         data-scroll-speed="{{ autoplay_interval }}"
         data-images-per-view="{{ images_per_view }}">
      
      <div class="image-carousel-container" 
           style="overflow: hidden;
                  position: relative;">
        {% if section.blocks.size > 0 %}
          <div class="carousel-track" 
               data-autoplay="{{ autoplay }}"
               data-scroll-speed="{{ autoplay_interval }}"
               style="display: flex;
                      gap: {{ image_gap }}px;
                      will-change: transform;">
            {% for block in section.blocks %}
              <div class="carousel-slide" 
                   data-slide-index="{{ forloop.index0 }}"
                   style="flex: 0 0 calc((100% - {{ image_gap | times: images_per_view | minus: image_gap }}px) / {{ images_per_view }});
                          min-width: 0;"
                   {{ block.shopify_attributes }}>
                {% if block.settings.image != blank %}
                  {% if block.settings.image_link != blank %}
                    <a href="{{ block.settings.image_link }}" class="carousel-image-link">
                  {% endif %}
                  <img src="{{ block.settings.image | img_url: '1920x1080' }}" 
                       alt="{{ block.settings.alt_text | escape }}"
                       class="carousel-image"
                       loading="lazy"
                       style="width: 100%;
                              height: {{ image_height }}px;
                              object-fit: {{ image_fit }};
                              display: block;
                              border-radius: 8px;">
                  {% if block.settings.image_link != blank %}
                    </a>
                  {% endif %}
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      
      {% if show_arrows %}
        <button class="carousel-arrow carousel-arrow-prev" 
                aria-label="Previous view"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="carousel-arrow carousel-arrow-next" 
                aria-label="Next view"
                style="width: {{ arrows_size }}px;
                       height: {{ arrows_size }}px;
                       background-color: {{ arrows_bg_color }};
                       opacity: {{ arrows_opacity_decimal }};
                       border-color: {{ arrows_color }};
                       color: {{ arrows_color }};">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      {% endif %}
      
      {% if show_dots %}
        <div class="carousel-dots">
          <button class="carousel-dot carousel-dot-pause" 
                  aria-label="Pause/Play carousel"
                  style="background-color: {{ dots_color }};"
                  title="Pause/Play">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>
        </div>
      {% endif %}
      
    </div>
  </div>
</section>

<style>
  .image-carousel-section {
    position: relative;
  }
  
  .image-carousel-wrapper {
    position: relative;
    width: 100%;
  }
  
  .image-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 8px;
  }
  
  .carousel-track {
    transition: transform 0.6s ease-in-out;
  }
  
  .carousel-track.paused {
    transition: none;
  }
  
  .carousel-image {
    width: 100%;
    display: block;
  }
  
  .carousel-image-link {
    display: block;
    width: 100%;
    height: 100%;
  }
  
  .carousel-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    border: 2px solid;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
  }
  
  .carousel-arrow:hover {
    opacity: 1 !important;
    transform: translateY(-50%) scale(1.1);
  }
  
  .carousel-arrow:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  .carousel-arrow-prev {
    left: 20px;
  }
  
  .carousel-arrow-next {
    right: 20px;
  }
  
  .carousel-arrow svg {
    width: 60%;
    height: 60%;
  }
  
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    padding: 0;
  }
  
  .carousel-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid {{ dots_color }};
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
    background-color: {{ arrows_bg_color }};
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ dots_color }};
  }
  
  .carousel-dot:hover {
    transform: scale(1.1);
    opacity: 0.9;
  }
  
  .carousel-dot svg {
    width: 16px;
    height: 16px;
  }
  
  @media (max-width: 767px) {
    .carousel-arrow-prev {
      left: 10px;
    }
    
    .carousel-arrow-next {
      right: 10px;
    }
    
    .carousel-arrow {
      width: 40px !important;
      height: 40px !important;
    }
    
    .carousel-dot {
      width: 36px;
      height: 36px;
    }
    
    /* Show 1 image per view on mobile */
    .carousel-slide {
      flex: 0 0 calc(100% - 10px) !important;
    }
  }
  
  @media (min-width: 768px) and (max-width: 1023px) {
    /* Show 2 images per view on tablet */
    .carousel-slide {
      flex: 0 0 calc((100% - 15px) / 2) !important;
    }
  }
</style>

<script>
  (function() {
    const carousel = document.getElementById('carousel-{{ section.id }}');
    if (!carousel) return;
    
    const wrapper = carousel.querySelector('.image-carousel-wrapper');
    const container = carousel.querySelector('.image-carousel-container');
    const track = carousel.querySelector('.carousel-track');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const pauseDot = carousel.querySelector('.carousel-dot-pause');
    const prevArrow = carousel.querySelector('.carousel-arrow-prev');
    const nextArrow = carousel.querySelector('.carousel-arrow-next');
    
    if (!track || slides.length === 0) return;
    
    const autoplay = wrapper.dataset.autoplay === 'true';
    const imagesPerView = parseInt(wrapper.dataset.imagesPerView) || 3;
    const totalSlides = slides.length;
    const totalViews = Math.ceil(totalSlides / imagesPerView);
    
    // Pause duration at each view (3 seconds)
    const PAUSE_DURATION = 3000; // 3 seconds
    const SCROLL_DURATION = 600; // 0.6 seconds for smooth transition
    
    let currentView = 0;
    let isPaused = false;
    let scrollTimeout = null;
    
    // Calculate the width of each slide (including gap)
    const containerWidth = container.offsetWidth;
    const slideWidth = containerWidth / imagesPerView;
    
    // Function to scroll to a specific view
    function scrollToView(viewIndex) {
      if (isPaused) return;
      
      // Reset if we've reached the end (seamlessly loop back)
      if (viewIndex >= totalViews) {
        viewIndex = 0;
        // Reset position immediately (no transition) for seamless loop
        track.style.transition = 'none';
        track.style.transform = 'translateX(0)';
        // Force reflow
        track.offsetHeight;
        // Restore transition
        track.style.transition = 'transform ' + SCROLL_DURATION + 'ms ease-in-out';
      }
      
      // Calculate the translateX value
      const translateX = -(viewIndex * slideWidth);
      track.style.transform = `translateX(${translateX}px)`;
      currentView = viewIndex;
    }
    
    // Function to move to next view
    function nextView() {
      if (isPaused) return;
      scrollToView(currentView + 1);
    }
    
    // Function to move to previous view
    function prevView() {
      if (isPaused) return;
      const prevIndex = currentView - 1;
      if (prevIndex < 0) {
        scrollToView(totalViews - 1);
      } else {
        scrollToView(prevIndex);
      }
    }
    
    // Start autoplay with pauses
    function startAutoplay() {
      if (!autoplay || isPaused) return;
      
      function advanceToNext() {
        if (isPaused) return;
        
        // Scroll to next view
        nextView();
        
        // Wait for scroll animation to complete, then pause
        setTimeout(() => {
          if (!isPaused) {
            // Pause for 3 seconds at this view
            scrollTimeout = setTimeout(() => {
              if (!isPaused) {
                advanceToNext();
              }
            }, PAUSE_DURATION);
          }
        }, SCROLL_DURATION);
      }
      
      // Start the cycle
      advanceToNext();
    }
    
    // Stop autoplay
    function stopAutoplay() {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
        scrollTimeout = null;
      }
    }
    
    // Pause/Play functionality
    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        track.classList.add('paused');
        stopAutoplay();
      } else {
        track.classList.remove('paused');
        startAutoplay();
      }
    }
    
    // Event listeners
    if (pauseDot) {
      pauseDot.addEventListener('click', togglePause);
    }
    
    if (prevArrow) {
      prevArrow.addEventListener('click', () => {
        stopAutoplay();
        prevView();
        if (autoplay && !isPaused) {
          setTimeout(startAutoplay, PAUSE_DURATION + SCROLL_DURATION);
        }
      });
    }
    
    if (nextArrow) {
      nextArrow.addEventListener('click', () => {
        stopAutoplay();
        nextView();
        if (autoplay && !isPaused) {
          setTimeout(startAutoplay, PAUSE_DURATION + SCROLL_DURATION);
        }
      });
    }
    
    // Pause on hover
    if (autoplay) {
      wrapper.addEventListener('mouseenter', () => {
        if (!isPaused) {
          track.classList.add('paused');
          stopAutoplay();
        }
      });
      
      wrapper.addEventListener('mouseleave', () => {
        if (!isPaused) {
          track.classList.remove('paused');
          startAutoplay();
        }
      });
    }
    
    // Handle window resize to recalculate positions
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newContainerWidth = container.offsetWidth;
        const newSlideWidth = newContainerWidth / imagesPerView;
        const translateX = -(currentView * newSlideWidth);
        track.style.transform = `translateX(${translateX}px)`;
      }, 250);
    });
    
    // Initialize
    scrollToView(0);
    if (autoplay) {
      // Start after initial pause
      setTimeout(startAutoplay, PAUSE_DURATION);
    } else {
      isPaused = true;
      track.classList.add('paused');
    }
  })();
</script>

