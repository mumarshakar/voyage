{% comment %}
  sections/booking-confirmation.liquid
  Display booking confirmation with customer details and "Proceed To Checkout" button
{% endcomment %}

{%- liquid
  # Get Telr payment settings
  assign telr_store_id = settings.telr_store_id | default: ''
  assign telr_auth_key = settings.telr_auth_key | default: ''
  assign telr_environment = settings.telr_environment | default: 'test'
  assign telr_success_url = settings.telr_success_url | default: ''
  assign telr_cancel_url = settings.telr_cancel_url | default: ''
  assign telr_failed_url = settings.telr_failed_url | default: ''
  assign telr_currency = settings.telr_currency | default: 'AED'
  
  # Use home page as fallback if URLs are not set
  if telr_success_url == blank
    assign telr_success_url = routes.root_url | append: '?booking=success'
  endif
  if telr_cancel_url == blank
    assign telr_cancel_url = routes.root_url | append: '?booking=cancel'
  endif
  if telr_failed_url == blank
    assign telr_failed_url = routes.root_url | append: '?booking=failed'
  endif
  
  # Section settings
  assign title = section.settings.title | default: 'Confirm Your Booking'
  assign subtitle = section.settings.subtitle | default: 'Please review your booking details below and proceed to checkout'
  assign background_color = section.settings.background_color | default: '#F8F7F5'
  assign text_color = section.settings.text_color | default: '#333333'
  assign heading_color = section.settings.heading_color | default: '#8B6F47'
  assign button_color = section.settings.button_color | default: '#8B6F47'
-%}

<div class="booking-confirmation-section" 
     id="booking-confirmation-{{ section.id }}"
     style="background-color: {{ background_color }};
            padding: 60px 20px;
            min-height: 60vh;">
  
  <div class="booking-confirmation-container" style="max-width: 900px; width: 100%; margin: 0 auto;">
    
    {% comment %} Page Title {% endcomment %}
    <div class="booking-confirmation-header" style="text-align: center; margin-bottom: 40px;">
      <h1 class="booking-confirmation-title" 
          style="font-size: 2.5rem;
                 font-weight: 600;
                 margin-bottom: 15px;
                 color: {{ heading_color }};
                 font-family: {{ section.settings.heading_font_family | default: 'Playfair Display, serif' }};">
        {{ title }}
      </h1>
      <p class="booking-confirmation-subtitle" 
         style="font-size: 1.2rem;
                color: {{ text_color }};
                line-height: 1.6;">
        {{ subtitle }}
      </p>
    </div>

    {% comment %} Booking Details Card {% endcomment %}
    <div id="booking-details-card-{{ section.id }}" 
         class="booking-details-card"
         style="background: #FFFFFF;
                border-radius: 2px;
                padding: 40px;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                display: none;">
      
      <h2 style="font-size: 1.8rem;
                 font-weight: 600;
                 margin-bottom: 30px;
                 color: {{ heading_color }};
                 text-align: center;
                 border-bottom: 2px solid #e0e0e0;
                 padding-bottom: 15px;">
        Booking Details
      </h2>
      
      <div class="booking-details-grid" 
           style="display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 25px;
                  margin-bottom: 30px;">
        <div id="booking-details-content-{{ section.id }}" class="booking-details-content">
          {% comment %} Populated by JavaScript {% endcomment %}
        </div>
      </div>
      
      {% comment %} Total Amount {% endcomment %}
      <div id="booking-total-{{ section.id }}" 
           class="booking-total"
           style="border-top: 2px solid #e0e0e0;
                  padding-top: 20px;
                  margin-top: 20px;
                  text-align: right;
                  display: none;">
        <div style="font-size: 1.5rem; font-weight: 600; color: {{ heading_color }};">
          <span style="color: #666666; margin-right: 10px;">Total Amount:</span>
          <span id="total-amount-{{ section.id }}"></span>
        </div>
      </div>
    </div>

    {% comment %} Error Message (if no booking data) {% endcomment %}
    <div id="booking-error-{{ section.id }}" 
         class="booking-error"
         style="background: #FFF3CD;
                border: 1px solid #FFC107;
                border-radius: 2px;
                padding: 20px;
                text-align: center;
                color: #856404;
                display: none;">
      <p style="margin: 0; font-size: 1.1rem;">
        No booking information found. Please go back and complete your booking.
      </p>
      <a href="{{ routes.root_url }}" 
         style="display: inline-block;
                margin-top: 15px;
                padding: 10px 20px;
                background-color: {{ button_color }};
                color: #FFFFFF;
                text-decoration: none;
                border-radius: 2px;
                font-weight: 600;">
        Back to Home
      </a>
    </div>

    {% comment %} Action Buttons {% endcomment %}
    <div id="booking-actions-{{ section.id }}" 
         class="booking-actions"
         style="display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 30px;
                display: none;">
      
      <button id="proceed-to-checkout-btn-{{ section.id }}" 
              class="btn-proceed-checkout"
              style="padding: 16px 40px;
                     background-color: {{ button_color }};
                     color: #FFFFFF;
                     border: none;
                     border-radius: 2px;
                     font-size: 1.1rem;
                     font-weight: 600;
                     cursor: pointer;
                     transition: all 0.3s ease;
                     min-width: 200px;">
        <span class="btn-text">Proceed To Checkout</span>
        <span class="btn-loading" style="display: none;">Redirecting...</span>
      </button>
      
      <a href="{{ routes.root_url }}" 
         class="btn-back"
         style="display: inline-block;
                padding: 16px 40px;
                background-color: transparent;
                color: {{ heading_color }};
                text-decoration: none;
                border: 2px solid {{ heading_color }};
                border-radius: 2px;
                font-size: 1.1rem;
                font-weight: 600;
                transition: all 0.3s ease;
                min-width: 200px;
                text-align: center;">
        Back to Home
      </a>
    </div>

  </div>
</div>

{% comment %} Hidden Telr Payment Form {% endcomment %}
<form id="telr-payment-form-{{ section.id }}" 
      method="post" 
      action="https://secure.telr.com/gateway/order.json" 
      style="position: absolute; left: -9999px; opacity: 0; pointer-events: none; width: 1px; height: 1px; overflow: hidden;"
      target="_self"
      accept-charset="UTF-8"
      enctype="application/x-www-form-urlencoded">
  <input type="hidden" name="ivp_method" value="create">
  <input type="hidden" name="ivp_store" id="telr-store-id-{{ section.id }}" value="{{ telr_store_id }}">
  <input type="hidden" name="ivp_authkey" id="telr-auth-key-{{ section.id }}" value="{{ telr_auth_key }}">
  <input type="hidden" name="ivp_amount" id="telr-amount-{{ section.id }}" value="">
  <input type="hidden" name="ivp_currency" id="telr-currency-{{ section.id }}" value="{{ telr_currency }}">
  <input type="hidden" name="ivp_test" id="telr-test-{{ section.id }}" value="{% if telr_environment == 'test' %}1{% else %}0{% endif %}">
  <input type="hidden" name="ivp_desc" id="telr-description-{{ section.id }}" value="">
  <input type="hidden" name="ivp_cart" id="telr-order-id-{{ section.id }}" value="">
  <input type="hidden" name="return_auth" id="telr-return-auth-{{ section.id }}" value="">
  <input type="hidden" name="return_can" id="telr-return-can-{{ section.id }}" value="">
  <input type="hidden" name="return_decl" id="telr-return-decl-{{ section.id }}" value="">
  <input type="hidden" name="bill_fname" id="telr-bill-fname-{{ section.id }}" value="">
  <input type="hidden" name="bill_lname" id="telr-bill-lname-{{ section.id }}" value="">
  <input type="hidden" name="bill_email" id="telr-bill-email-{{ section.id }}" value="">
  <input type="hidden" name="bill_mobile" id="telr-bill-mobile-{{ section.id }}" value="">
</form>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const bookingDetailsCard = document.getElementById('booking-details-card-' + sectionId);
    const bookingDetailsContent = document.getElementById('booking-details-content-' + sectionId);
    const bookingTotal = document.getElementById('booking-total-' + sectionId);
    const totalAmount = document.getElementById('total-amount-' + sectionId);
    const bookingError = document.getElementById('booking-error-' + sectionId);
    const bookingActions = document.getElementById('booking-actions-' + sectionId);
    const proceedButton = document.getElementById('proceed-to-checkout-btn-' + sectionId);
    
    // Try to get booking data from sessionStorage
    let bookingData = null;
    try {
      const bookingDataStr = sessionStorage.getItem('booking_data');
      console.log('Booking data from sessionStorage:', bookingDataStr);
      if (bookingDataStr) {
        bookingData = JSON.parse(bookingDataStr);
        console.log('Parsed booking data:', bookingData);
      } else {
        console.warn('No booking data found in sessionStorage');
      }
    } catch (e) {
      console.error('Error parsing booking data:', e);
    }
    
    // Display booking details if data exists
    if (bookingData) {
      // Build booking details HTML
      let detailsHTML = '';
      
      if (bookingData.orderId) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Order ID</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.orderId + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.eventTitle) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Event</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.eventTitle + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.eventDate) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Event Date</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.eventDate + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.customerName) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Full Name</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.customerName + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.customerEmail) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Email</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.customerEmail + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.customerPhone) {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Phone</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.customerPhone + '</div>';
        detailsHTML += '</div>';
      }
      
      if (bookingData.notes && bookingData.notes.trim() !== '') {
        detailsHTML += '<div class="detail-item" style="margin-bottom: 20px; grid-column: 1 / -1;">';
        detailsHTML += '<div style="font-weight: 600; color: #666666; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Additional Notes</div>';
        detailsHTML += '<div style="font-size: 1.1rem; color: #333333; font-weight: 500;">' + bookingData.notes + '</div>';
        detailsHTML += '</div>';
      }
      
      bookingDetailsContent.innerHTML = detailsHTML;
      bookingDetailsCard.style.display = 'block';
      bookingActions.style.display = 'flex';
      
      // Show total amount if price > 0
      const price = parseFloat(bookingData.amount) || 0;
      if (price > 0) {
        const currency = bookingData.currency || '{{ telr_currency }}';
        totalAmount.textContent = parseFloat(bookingData.amount).toFixed(2) + ' ' + currency;
        bookingTotal.style.display = 'block';
        // Show proceed to checkout button for paid events
        if (proceedButton) {
          proceedButton.style.display = 'inline-block';
        }
      } else {
        bookingTotal.style.display = 'none';
        // Hide proceed to checkout button for free events
        if (proceedButton) {
          proceedButton.style.display = 'none';
        }
        // For free events, they should have gone directly to success page
        // But if they somehow reached here, show a message
        if (bookingActions) {
          const freeEventMsg = document.createElement('p');
          freeEventMsg.textContent = 'This is a free event. Your booking has been confirmed!';
          freeEventMsg.style.cssText = 'text-align: center; color: #4CAF50; font-weight: 600; margin-top: 20px;';
          bookingActions.appendChild(freeEventMsg);
        }
      }
    } else {
      // No booking data - show error
      bookingError.style.display = 'block';
      bookingDetailsCard.style.display = 'none';
      bookingActions.style.display = 'none';
    }
    
    // Handle "Proceed To Checkout" button click
    if (proceedButton && bookingData) {
      proceedButton.addEventListener('click', function() {
        const btnText = proceedButton.querySelector('.btn-text');
        const btnLoading = proceedButton.querySelector('.btn-loading');
        
        // Disable button and show loading
        proceedButton.disabled = true;
        if (btnText) btnText.style.display = 'none';
        if (btnLoading) btnLoading.style.display = 'inline';
        
        // Get Telr credentials
        const telrStoreId = '{{ telr_store_id }}';
        const telrAuthKey = '{{ telr_auth_key }}';
        
        if (!telrStoreId || !telrAuthKey) {
          alert('Payment gateway is not configured. Please contact the store owner.');
          proceedButton.disabled = false;
          if (btnText) btnText.style.display = 'inline';
          if (btnLoading) btnLoading.style.display = 'none';
          return;
        }
        
        // Get booking data
        const price = parseFloat(bookingData.amount) || 0;
        const orderId = bookingData.orderId;
        const eventTitle = bookingData.eventTitle;
        const eventDate = bookingData.eventDate;
        const customerName = bookingData.customerName;
        const customerEmail = bookingData.customerEmail;
        const customerPhone = bookingData.customerPhone;
        
        // Split name into first and last name
        const nameParts = customerName.trim().split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || firstName;
        
        // Prepare URLs
        const shopUrl = '{{ shop.url }}';
        const successUrl = '{{ telr_success_url }}';
        const cancelUrl = '{{ telr_cancel_url }}';
        const failedUrl = '{{ telr_failed_url }}';
        
        const finalSuccessUrl = successUrl.startsWith('http') ? successUrl : (shopUrl + successUrl);
        const finalCancelUrl = cancelUrl.startsWith('http') ? cancelUrl : (shopUrl + cancelUrl);
        const finalFailedUrl = failedUrl.startsWith('http') ? failedUrl : (shopUrl + failedUrl);
        
        // Create Telr payment form dynamically
        console.log('=== Redirecting to Telr Payment Gateway ===');
        console.log('Store ID:', telrStoreId);
        console.log('Amount:', price.toFixed(2), '{{ telr_currency }}');
        console.log('Order ID:', orderId);
        
        const telrPaymentForm = document.createElement('form');
        telrPaymentForm.method = 'POST';
        telrPaymentForm.action = 'https://secure.telr.com/gateway/order.json';
        telrPaymentForm.style.cssText = 'display:none !important; position:absolute; left:-9999px; width:1px; height:1px;';
        telrPaymentForm.target = '_self';
        telrPaymentForm.acceptCharset = 'UTF-8';
        
        // Add all required Telr fields
        const fields = [
          { name: 'ivp_method', value: 'create' },
          { name: 'ivp_store', value: telrStoreId },
          { name: 'ivp_authkey', value: telrAuthKey },
          { name: 'ivp_amount', value: price.toFixed(2) },
          { name: 'ivp_currency', value: '{{ telr_currency }}' },
          { name: 'ivp_test', value: '{% if telr_environment == "test" %}1{% else %}0{% endif %}' },
          { name: 'ivp_desc', value: 'Booking: ' + eventTitle + ' - ' + eventDate },
          { name: 'ivp_cart', value: orderId },
          { name: 'return_auth', value: finalSuccessUrl },
          { name: 'return_can', value: finalCancelUrl },
          { name: 'return_decl', value: finalFailedUrl },
          { name: 'bill_fname', value: firstName },
          { name: 'bill_lname', value: lastName },
          { name: 'bill_email', value: customerEmail },
          { name: 'bill_mobile', value: customerPhone }
        ];
        
        // Add all fields to form
        fields.forEach(function(field) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = field.name;
          input.value = field.value;
          telrPaymentForm.appendChild(input);
        });
        
        // Append form to body
        document.body.appendChild(telrPaymentForm);
        
        // Submit form immediately - this will redirect browser to Telr payment page
        console.log('Submitting form to Telr payment gateway...');
        telrPaymentForm.submit();
      });
    }
  })();
</script>

<style>
  .booking-confirmation-section {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  }

  .btn-proceed-checkout:hover {
    background-color: #6B5B4F !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-proceed-checkout:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-back:hover {
    background-color: {{ heading_color }} !important;
    color: #FFFFFF !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 768px) {
    .booking-confirmation-title {
      font-size: 2rem !important;
    }
    
    .booking-confirmation-subtitle {
      font-size: 1rem !important;
    }
    
    .booking-details-card {
      padding: 25px !important;
    }
    
    .booking-actions {
      flex-direction: column !important;
    }
    
    .booking-actions button,
    .booking-actions a {
      width: 100% !important;
    }
  }
</style>

{% schema %}
{
  "name": "Booking Confirmation",
  "tag": "section",
  "class": "section-booking-confirmation",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Confirm Your Booking"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Please review your booking details below and proceed to checkout"
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#F8F7F5"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#8B6F47"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#8B6F47"
    },
    {
      "type": "select",
      "id": "heading_font_family",
      "label": "Heading Font Family",
      "options": [
        {
          "value": "Playfair Display, serif",
          "label": "Playfair Display"
        },
        {
          "value": "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
          "label": "Segoe UI"
        },
        {
          "value": "Arial, sans-serif",
          "label": "Arial"
        }
      ],
      "default": "Playfair Display, serif"
    }
  ],
  "presets": [
    {
      "name": "Booking Confirmation"
    }
  ]
}
{% endschema %}

