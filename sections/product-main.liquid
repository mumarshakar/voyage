{%- liquid
  assign show_vendor = section.settings.show_vendor | default: false
  assign show_sku = section.settings.show_sku | default: false
  assign show_quantity_selector = section.settings.show_quantity_selector | default: true
  assign enable_dynamic_checkout = section.settings.enable_dynamic_checkout | default: false
  assign show_thumbnails = section.settings.show_thumbnails | default: true
  assign section_height_desktop = section.settings.section_height_desktop | default: 600
  assign section_height_mobile = section.settings.section_height_mobile | default: 400
  assign padding_top_desktop = section.settings.padding_top_desktop | default: 60
  assign padding_bottom_desktop = section.settings.padding_bottom_desktop | default: 60
  assign padding_horizontal_desktop = section.settings.padding_horizontal_desktop | default: 20
  assign margin_top_desktop = section.settings.margin_top_desktop | default: 0
  assign margin_bottom_desktop = section.settings.margin_bottom_desktop | default: 0
  assign padding_top_mobile = section.settings.padding_top_mobile | default: 40
  assign padding_bottom_mobile = section.settings.padding_bottom_mobile | default: 40
  assign padding_horizontal_mobile = section.settings.padding_horizontal_mobile | default: 20
  assign margin_top_mobile = section.settings.margin_top_mobile | default: 0
  assign margin_bottom_mobile = section.settings.margin_bottom_mobile | default: 0
-%}

<div class="product-main-section" style="padding-top: {{ padding_top_desktop }}px; padding-bottom: {{ padding_bottom_desktop }}px; padding-left: {{ padding_horizontal_desktop }}px; padding-right: {{ padding_horizontal_desktop }}px; margin-top: {{ margin_top_desktop }}px; margin-bottom: {{ margin_bottom_desktop }}px;">
  <div class="container">
    <div class="row g-5 align-items-start">
      <!-- Product Images Column -->
      <div class="col-lg-6">
        {% if product.featured_image %}
          <div class="product-image-main mb-3">
            <img 
              id="product-main-image"
              src="{{ product.featured_image | image_url: width: 1200 }}"
              alt="{{ product.featured_image.alt | escape }}"
              width="{{ product.featured_image.width }}"
              height="{{ product.featured_image.height }}"
              class="img-fluid w-100"
              style="border-radius: 8px; object-fit: cover; max-height: 800px; cursor: pointer;"
              loading="eager"
              onclick="zoomProductImage(this)">
          </div>
        {% endif %}

        {% if show_thumbnails and product.images.size > 1 %}
          <div class="product-thumbnails d-flex gap-3 overflow-x-auto pb-2">
            {% for image in product.images %}
              <button 
                type="button"
                class="product-thumbnail-btn border-0 bg-transparent p-0"
                data-image-src="{{ image | image_url: width: 1200 }}"
                style="flex-shrink: 0; cursor: pointer; opacity: {% if forloop.first %}1{% else %}0.6{% endif %}; transition: opacity 0.3s;"
                onclick="changeProductImage(this)">
                <img 
                  src="{{ image | image_url: width: 200 }}"
                  alt="{{ image.alt | escape }}"
                  width="80"
                  height="80"
                  class="img-fluid"
                  style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid {% if forloop.first %}var(--primary-orange, #FF6B35){% else %}transparent{% endif %};"
                  loading="lazy">
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Product Info Column -->
      <div class="col-lg-6">
        {% if show_vendor and product.vendor != blank %}
          <div class="product-vendor mb-2" style="font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 0.1em;">
            {{ product.vendor }}
          </div>
        {% endif %}

        <h1 class="product-title mb-3">{{ product.title }}</h1>

        <div class="product-price mb-4">
          {% if product.compare_at_price > product.price %}
            <span class="product-price-compare text-muted text-decoration-line-through me-2" style="font-size: 18px;">
              {{ product.compare_at_price | money }}
            </span>
            <span class="product-price-current text-danger" style="font-size: 24px; font-weight: 600;">
              {{ product.price | money }}
            </span>
            <span class="product-price-save ms-2" style="color: var(--primary-orange, #FF6B35); font-weight: 600;">
              Save {{ product.compare_at_price | minus: product.price | money }}
            </span>
          {% else %}
            <span class="product-price-current" style="font-size: 28px; font-weight: 600;">
              {{ product.price | money }}
            </span>
          {% endif %}
        </div>

        {% if show_sku and product.selected_or_first_available_variant.sku != blank %}
          <div class="product-sku mb-4" style="font-size: 14px; color: #666;">
            SKU: <strong>{{ product.selected_or_first_available_variant.sku }}</strong>
          </div>
        {% endif %}

        {% if product.available == false %}
          <div class="alert alert-danger mb-4" role="alert">
            This product is currently out of stock.
          </div>
        {% else %}
          <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="product-form" data-product-id="{{ product.id }}" class="product-form">
            <!-- Variants Card -->
            {% if product.variants.size > 1 %}
              <div class="card mb-3" style="background-color: #f8f9fa;">
                <div class="card-body">
                  <h6 class="card-title mb-3 fw-semibold">Select Options</h6>
                  <input type="hidden" name="id" id="selected-variant-id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                  {% for option in product.options_with_values %}
                    <div class="mb-3">
                      <label for="option-{{ forloop.index }}" class="form-label fw-semibold mb-2">
                        {{ option.name }}
                      </label>
                      <select 
                        id="option-{{ forloop.index }}"
                        class="form-select product-option-select"
                        required
                        data-option-index="{{ option.position | minus: 1 }}"
                        onchange="updateSelectedVariant()">
                        {% for value in option.values %}
                          <option 
                            value="{{ value | escape }}"
                            {% if option.selected_value == value %}selected{% endif %}>
                            {{ value }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <input type="hidden" name="id" id="selected-variant-id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
            {% endif %}

            <!-- Quantity Card -->
            {% if show_quantity_selector %}
              <div class="card mb-3" style="background-color: #f8f9fa;">
                <div class="card-body">
                  <label for="quantity" class="form-label fw-semibold mb-2">Quantity</label>
                  <div class="input-group" style="max-width: 200px;">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      onclick="decreaseQuantity()"
                      style="border-color: #dee2e6;">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input 
                      type="number" 
                      id="quantity" 
                      name="quantity" 
                      value="1" 
                      min="1" 
                      class="form-control text-center"
                      style="border-color: #dee2e6;">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      onclick="increaseQuantity()"
                      style="border-color: #dee2e6;">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            {% else %}
              <input type="hidden" name="quantity" value="1" id="quantity">
            {% endif %}

            <!-- Add to Cart and Buy Now Buttons -->
            <div class="card mb-3" style="background-color: #f8f9fa;">
              <div class="card-body">
                <div class="d-flex flex-column gap-3">
                  <!-- Add to Cart Button -->
                  <button 
                    type="submit" 
                    name="add" 
                    id="add-to-cart-btn"
                    class="btn btn-primary w-100"
                    style="height: 50px; font-size: 18px; font-weight: 600;"
                    {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                    <i class="bi bi-cart-plus me-2"></i>
                    {% if product.selected_or_first_available_variant.available %}
                      Add to Cart
                    {% else %}
                      Out of Stock
                    {% endif %}
                  </button>

                  <!-- Buy Now Button (Direct Checkout) -->
                  <button 
                    type="button" 
                    id="buy-now-btn"
                    class="btn btn-success w-100"
                    style="height: 50px; font-size: 18px; font-weight: 600; background-color: #28a745; border-color: #28a745;"
                    {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
                    <i class="bi bi-bag-check me-2"></i>
                    Buy Now
                  </button>
                </div>
              </div>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  const productVariants = [
    {% for variant in product.variants %}
    {
      id: {{ variant.id }},
      title: "{{ variant.title | escape }}",
      price: {{ variant.price }},
      priceFormatted: "{{ variant.price | money }}",
      compare_at_price: {{ variant.compare_at_price | default: 0 }},
      compare_at_priceFormatted: "{{ variant.compare_at_price | money | default: '' }}",
      available: {{ variant.available | json }},
      option1: "{{ variant.option1 | escape }}",
      option2: "{{ variant.option2 | escape }}",
      option3: "{{ variant.option3 | escape }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  
  function changeProductImage(button) {
    const imageSrc = button.dataset.imageSrc;
    const mainImage = document.getElementById('product-main-image');
    if (mainImage && imageSrc) {
      mainImage.src = imageSrc;
      
      // Update thumbnail opacity
      document.querySelectorAll('.product-thumbnail-btn').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.querySelector('img').style.borderColor = 'transparent';
      });
      button.style.opacity = '1';
      button.querySelector('img').style.borderColor = 'var(--primary-orange, #FF6B35)';
    }
  }
  
  function zoomProductImage(img) {
    if (img.style.transform === 'scale(2)') {
      img.style.transform = 'scale(1)';
      img.style.cursor = 'pointer';
    } else {
      img.style.transform = 'scale(2)';
      img.style.cursor = 'zoom-out';
    }
  }
  
  function updateSelectedVariant() {
    const selects = document.querySelectorAll('.product-option-select');
    const selectedOptions = [];
    
    selects.forEach(select => {
      selectedOptions.push(select.value);
    });
    
    // Find matching variant
    const variant = productVariants.find(v => {
      let match = true;
      if (selectedOptions[0] && v.option1 !== selectedOptions[0]) match = false;
      if (selectedOptions[1] && v.option2 !== selectedOptions[1]) match = false;
      if (selectedOptions[2] && v.option3 !== selectedOptions[2]) match = false;
      return match;
    });
    
    if (variant) {
      // Update hidden variant ID input
      const variantIdInput = document.getElementById('selected-variant-id');
      if (variantIdInput) {
        variantIdInput.value = variant.id;
      }
      
      // Update price display
      updatePrice(variant.priceFormatted, variant.compare_at_priceFormatted, variant.price, variant.compare_at_price);
      
      // Update button state
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const buyNowBtn = document.getElementById('buy-now-btn');
      if (addToCartBtn) {
        addToCartBtn.disabled = !variant.available;
        addToCartBtn.innerHTML = variant.available 
          ? '<i class="bi bi-cart-plus me-2"></i>Add to Cart' 
          : '<i class="bi bi-x-circle me-2"></i>Out of Stock';
      }
      if (buyNowBtn) {
        buyNowBtn.disabled = !variant.available;
      }
    }
  }
  
  function updatePrice(priceFormatted, compareAtPriceFormatted, price, compareAtPrice) {
    const priceContainer = document.querySelector('.product-price');
    if (!priceContainer) return;
    
    if (compareAtPrice && compareAtPrice > price && compareAtPriceFormatted) {
      const savingsCents = compareAtPrice - price;
      const savingsFormatted = (savingsCents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code | default: "USD" }}'
      });
      
      priceContainer.innerHTML = `
        <span class="product-price-compare text-muted text-decoration-line-through me-2" style="font-size: 18px;">${compareAtPriceFormatted}</span>
        <span class="product-price-current text-danger" style="font-size: 24px; font-weight: 600;">${priceFormatted}</span>
        <span class="product-price-save ms-2" style="color: var(--primary-orange, #FF6B35); font-weight: 600;">Save ${savingsFormatted}</span>
      `;
    } else {
      priceContainer.innerHTML = `
        <span class="product-price-current" style="font-size: 28px; font-weight: 600;">${priceFormatted}</span>
      `;
    }
  }
  
  function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.value = parseInt(quantityInput.value) + 1;
    }
  }
  
  function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput && parseInt(quantityInput.value) > 1) {
      quantityInput.value = parseInt(quantityInput.value) - 1;
    }
  }
  
  // Handle add to cart form submission
  const productForm = document.getElementById('product-form');
  if (productForm) {
    // Handle Add to Cart button
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(productForm);
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const originalText = addToCartBtn ? addToCartBtn.innerHTML : 'Add to Cart';
      
      // Disable button and show loading state
      if (addToCartBtn) {
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
      }
      
      fetch('{{ routes.cart_add_url }}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          // Success - redirect to cart
          window.location.href = '{{ routes.cart_url }}';
        } else {
          // Error handling
          if (addToCartBtn) {
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = originalText;
          }
          
          if (data.description) {
            alert('Error: ' + data.description);
          } else {
            alert('There was an error adding the product to your cart. Please try again.');
          }
        }
      })
      .catch((error) => {
        console.error('Error adding to cart:', error);
        if (addToCartBtn) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;
        }
        alert('There was an error adding the product to your cart. Please try again.');
      });
    });
    
    // Handle Buy Now button (direct checkout)
    const buyNowBtn = document.getElementById('buy-now-btn');
    if (buyNowBtn) {
      buyNowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const formData = new FormData(productForm);
        const originalText = buyNowBtn.innerHTML;
        
        // Disable button and show loading state
        buyNowBtn.disabled = true;
        buyNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
        
        fetch('{{ routes.cart_add_url }}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.id) {
            // Success - redirect directly to checkout
            window.location.href = '{{ routes.cart_url }}?view=checkout';
          } else {
            // Error handling
            buyNowBtn.disabled = false;
            buyNowBtn.innerHTML = originalText;
            
            if (data.description) {
              alert('Error: ' + data.description);
            } else {
              alert('There was an error processing your order. Please try again.');
            }
          }
        })
        .catch((error) => {
          console.error('Error with Buy Now:', error);
          buyNowBtn.disabled = false;
          buyNowBtn.innerHTML = originalText;
          alert('There was an error processing your order. Please try again.');
        });
      });
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    {% if product.variants.size > 1 %}
      updateSelectedVariant();
    {% endif %}
  });
  
</script>

<style>
  .product-thumbnails {
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange, #FF6B35) transparent;
  }
  
  .product-thumbnails::-webkit-scrollbar {
    height: 6px;
  }
  
  .product-thumbnails::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .product-thumbnails::-webkit-scrollbar-thumb {
    background-color: var(--primary-orange, #FF6B35);
    border-radius: 3px;
  }
  
  .product-thumbnail-btn:hover {
    opacity: 1 !important;
  }
  
  #product-main-image {
    transition: transform 0.3s ease;
  }
  
  @media (max-width: 991px) {
    .product-main-section {
      padding-top: {{ padding_top_mobile }}px !important;
      padding-bottom: {{ padding_bottom_mobile }}px !important;
      padding-left: {{ padding_horizontal_mobile }}px !important;
      padding-right: {{ padding_horizontal_mobile }}px !important;
      margin-top: {{ margin_top_mobile }}px !important;
      margin-bottom: {{ margin_bottom_mobile }}px !important;
      min-height: {{ section_height_mobile }}px !important;
      height: {{ section_height_mobile }}px !important;
    }
  }
  
  /* Desktop: Section Height and Spacing */
  @media (min-width: 992px) {
    .product-main-section {
      min-height: {{ section_height_desktop }}px !important;
      height: {{ section_height_desktop }}px !important;
    }
  }
</style>

{% schema %}
{
  "name": "Product Main",
  "settings": [
    {
      "type": "header",
      "content": "Product Images"
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show Thumbnails",
      "default": true,
      "info": "Display thumbnail images below the main product image"
    },
    {
      "type": "header",
      "content": "Product Information"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show Vendor",
      "default": false,
      "info": "Display the product vendor name"
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "label": "Show SKU",
      "default": false,
      "info": "Display the product SKU"
    },
    {
      "type": "checkbox",
      "id": "show_quantity_selector",
      "label": "Show Quantity Selector",
      "default": true,
      "info": "Allow customers to select quantity before adding to cart"
    },
    {
      "type": "checkbox",
      "id": "enable_dynamic_checkout",
      "label": "Enable Dynamic Checkout Buttons",
      "default": false,
      "info": "Show payment provider buttons (PayPal, Apple Pay, etc.)"
    },
    {
      "type": "header",
      "content": "Section Height"
    },
    {
      "type": "range",
      "id": "section_height_desktop",
      "label": "Section Height - Desktop (px)",
      "min": 200,
      "max": 1500,
      "step": 50,
      "default": 600,
      "unit": "px",
      "info": "Height of section on desktop screens (992px and above)"
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "label": "Section Height - Mobile (px)",
      "min": 200,
      "max": 1000,
      "step": 50,
      "default": 400,
      "unit": "px",
      "info": "Height of section on mobile screens (below 992px)"
    },
    {
      "type": "header",
      "content": "Spacing - Desktop"
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Top Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Bottom Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_desktop",
      "label": "Horizontal Padding - Desktop (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_desktop",
      "label": "Top Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_desktop",
      "label": "Bottom Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Spacing - Mobile"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Top Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Bottom Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_mobile",
      "label": "Horizontal Padding - Mobile (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_mobile",
      "label": "Top Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_mobile",
      "label": "Bottom Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Product Main"
    }
  ]
}
{% endschema %}

