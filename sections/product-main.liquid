{%- liquid
  assign padding_top_desktop = section.settings.padding_top_desktop | default: 60
  assign padding_bottom_desktop = section.settings.padding_bottom_desktop | default: 60
  assign padding_horizontal_desktop = section.settings.padding_horizontal_desktop | default: 20
  assign margin_top_desktop = section.settings.margin_top_desktop | default: 0
  assign margin_bottom_desktop = section.settings.margin_bottom_desktop | default: 0
  assign padding_top_mobile = section.settings.padding_top_mobile | default: 40
  assign padding_bottom_mobile = section.settings.padding_bottom_mobile | default: 40
  assign padding_horizontal_mobile = section.settings.padding_horizontal_mobile | default: 20
  assign margin_top_mobile = section.settings.margin_top_mobile | default: 0
  assign margin_bottom_mobile = section.settings.margin_bottom_mobile | default: 0
  assign section_height_desktop = section.settings.section_height_desktop | default: 600
  assign section_height_mobile = section.settings.section_height_mobile | default: 400
  assign desktop_media_position = section.settings.desktop_media_position | default: 'left'
  assign swap_columns_mobile = section.settings.swap_columns_mobile | default: false
-%}

<script type="application/ld+json">
  {{ product | structured_data }}
</script>

{%- liquid
  assign media_gallery_content = ''
  assign product_details_content = ''
  assign additional_blocks_content = ''
  
  for block in section.blocks
    case block.type
      when 'product-media-gallery'
        capture media_gallery_content
          render block
        endcapture
      when 'product-details'
        capture product_details_content
          render block
        endcapture
      when '@app'
        capture app_block_content
          render block
        endcapture
        assign additional_blocks_content = additional_blocks_content | append: app_block_content
    endcase
  endfor
-%}

{% render 'product-main-content',
  media_gallery: media_gallery_content,
  product_details: product_details_content,
  additional_blocks: additional_blocks_content,
  settings: section.settings
%}

<script>
  const productVariants = [
    {% for variant in product.variants %}
    {
      id: {{ variant.id }},
      title: "{{ variant.title | escape }}",
      price: {{ variant.price }},
      priceFormatted: "{{ variant.price | money }}",
      compare_at_price: {{ variant.compare_at_price | default: 0 }},
      compare_at_priceFormatted: "{{ variant.compare_at_price | money | default: '' }}",
      available: {{ variant.available | json }},
      option1: "{{ variant.option1 | escape }}",
      option2: "{{ variant.option2 | escape }}",
      option3: "{{ variant.option3 | escape }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  
  function changeProductImage(button) {
    const imageSrc = button.dataset.imageSrc;
    const mainImage = document.getElementById('product-main-image');
    if (mainImage && imageSrc) {
      mainImage.src = imageSrc;
      
      // Update thumbnail opacity
      document.querySelectorAll('.product-thumbnail-btn').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.querySelector('img').style.borderColor = 'transparent';
      });
      button.style.opacity = '1';
      button.querySelector('img').style.borderColor = 'var(--primary-orange, #FF6B35)';
    }
  }
  
  function zoomProductImage(img) {
    if (img.style.transform === 'scale(2)') {
      img.style.transform = 'scale(1)';
      img.style.cursor = 'pointer';
    } else {
      img.style.transform = 'scale(2)';
      img.style.cursor = 'zoom-out';
    }
  }
  
  function updateSelectedVariant() {
    const selects = document.querySelectorAll('.product-option-select');
    const selectedOptions = [];
    
    selects.forEach(select => {
      selectedOptions.push(select.value);
    });
    
    // Find matching variant
    const variant = productVariants.find(v => {
      let match = true;
      if (selectedOptions[0] && v.option1 !== selectedOptions[0]) match = false;
      if (selectedOptions[1] && v.option2 !== selectedOptions[1]) match = false;
      if (selectedOptions[2] && v.option3 !== selectedOptions[2]) match = false;
      return match;
    });
    
    if (variant) {
      // Update hidden variant ID input
      const variantIdInput = document.getElementById('selected-variant-id');
      if (variantIdInput) {
        variantIdInput.value = variant.id;
      }
      
      // Update price display
      updatePrice(variant.priceFormatted, variant.compare_at_priceFormatted, variant.price, variant.compare_at_price);
      
      // Update button state
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const buyNowBtn = document.getElementById('buy-now-btn');
      if (addToCartBtn) {
        addToCartBtn.disabled = !variant.available;
        addToCartBtn.innerHTML = variant.available 
          ? '<i class="bi bi-cart-plus me-2"></i>Add to Cart' 
          : '<i class="bi bi-x-circle me-2"></i>Out of Stock';
      }
      if (buyNowBtn) {
        buyNowBtn.disabled = !variant.available;
      }
    }
  }
  
  function updatePrice(priceFormatted, compareAtPriceFormatted, price, compareAtPrice) {
    const priceContainer = document.querySelector('.product-price');
    if (!priceContainer) return;
    
    if (compareAtPrice && compareAtPrice > price && compareAtPriceFormatted) {
      const savingsCents = compareAtPrice - price;
      const savingsFormatted = (savingsCents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code | default: "USD" }}'
      });
      
      priceContainer.innerHTML = `
        <span class="product-price-compare text-muted text-decoration-line-through me-2" style="font-size: 18px;">${compareAtPriceFormatted}</span>
        <span class="product-price-current text-danger" style="font-size: 24px; font-weight: 600;">${priceFormatted}</span>
        <span class="product-price-save ms-2" style="color: var(--primary-orange, #FF6B35); font-weight: 600;">Save ${savingsFormatted}</span>
      `;
    } else {
      priceContainer.innerHTML = `
        <span class="product-price-current" style="font-size: 28px; font-weight: 600;">${priceFormatted}</span>
      `;
    }
  }
  
  function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.value = parseInt(quantityInput.value) + 1;
    }
  }
  
  function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput && parseInt(quantityInput.value) > 1) {
      quantityInput.value = parseInt(quantityInput.value) - 1;
    }
  }
  
  // Handle add to cart form submission
  const productForm = document.getElementById('product-form');
  if (productForm) {
    // Handle Add to Cart button
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(productForm);
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const originalText = addToCartBtn ? addToCartBtn.innerHTML : 'Add to Cart';
      
      // Disable button and show loading state
      if (addToCartBtn) {
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
      }
      
      fetch('{{ routes.cart_add_url }}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          // Success - redirect to cart
          window.location.href = '{{ routes.cart_url }}';
        } else {
          // Error handling
          if (addToCartBtn) {
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = originalText;
          }
          
          if (data.description) {
            alert('Error: ' + data.description);
          } else {
            alert('There was an error adding the product to your cart. Please try again.');
          }
        }
      })
      .catch((error) => {
        console.error('Error adding to cart:', error);
        if (addToCartBtn) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;
        }
        alert('There was an error adding the product to your cart. Please try again.');
      });
    });
    
    // Handle Buy Now button (direct checkout)
    const buyNowBtn = document.getElementById('buy-now-btn');
    if (buyNowBtn) {
      buyNowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const formData = new FormData(productForm);
        const originalText = buyNowBtn.innerHTML;
        
        // Disable button and show loading state
        buyNowBtn.disabled = true;
        buyNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
        
        fetch('{{ routes.cart_add_url }}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.id) {
            // Success - redirect directly to checkout
            window.location.href = '{{ routes.cart_url }}?view=checkout';
          } else {
            // Error handling
            buyNowBtn.disabled = false;
            buyNowBtn.innerHTML = originalText;
            
            if (data.description) {
              alert('Error: ' + data.description);
            } else {
              alert('There was an error processing your order. Please try again.');
            }
          }
        })
        .catch((error) => {
          console.error('Error with Buy Now:', error);
          buyNowBtn.disabled = false;
          buyNowBtn.innerHTML = originalText;
          alert('There was an error processing your order. Please try again.');
        });
      });
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    {% if product.variants.size > 1 %}
      updateSelectedVariant();
    {% endif %}
  });
  
</script>

{% schema %}
{
  "name": "Product Main",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "product-media-gallery",
      "name": "Product Media Gallery"
    },
    {
      "type": "product-details",
      "name": "Product Details"
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Media Position (Desktop)",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left",
      "info": "Position of product images on desktop screens"
    },
    {
      "type": "checkbox",
      "id": "swap_columns_mobile",
      "label": "Swap Columns on Mobile",
      "default": false,
      "info": "Show product details above images on mobile"
    },
    {
      "type": "header",
      "content": "Section Height"
    },
    {
      "type": "range",
      "id": "section_height_desktop",
      "label": "Section Height - Desktop (px)",
      "min": 200,
      "max": 1500,
      "step": 50,
      "default": 600,
      "unit": "px",
      "info": "Height of section on desktop screens (992px and above)"
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "label": "Section Height - Mobile (px)",
      "min": 200,
      "max": 1000,
      "step": 50,
      "default": 400,
      "unit": "px",
      "info": "Height of section on mobile screens (below 992px)"
    },
    {
      "type": "header",
      "content": "Spacing - Desktop"
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Top Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Bottom Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_desktop",
      "label": "Horizontal Padding - Desktop (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_desktop",
      "label": "Top Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_desktop",
      "label": "Bottom Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Spacing - Mobile"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Top Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Bottom Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_mobile",
      "label": "Horizontal Padding - Mobile (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_mobile",
      "label": "Top Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_mobile",
      "label": "Bottom Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Product Main",
      "blocks": [
        {
          "type": "product-media-gallery"
        },
        {
          "type": "product-details"
        }
      ]
    }
  ]
}
{% endschema %}
