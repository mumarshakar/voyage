{%- liquid
  assign padding_top_desktop = section.settings.padding_top_desktop | default: 60
  assign padding_bottom_desktop = section.settings.padding_bottom_desktop | default: 60
  assign padding_horizontal_desktop = section.settings.padding_horizontal_desktop | default: 20
  assign margin_top_desktop = section.settings.margin_top_desktop | default: 0
  assign margin_bottom_desktop = section.settings.margin_bottom_desktop | default: 0
  assign padding_top_mobile = section.settings.padding_top_mobile | default: 40
  assign padding_bottom_mobile = section.settings.padding_bottom_mobile | default: 40
  assign padding_horizontal_mobile = section.settings.padding_horizontal_mobile | default: 20
  assign margin_top_mobile = section.settings.margin_top_mobile | default: 0
  assign margin_bottom_mobile = section.settings.margin_bottom_mobile | default: 0
  assign section_height_desktop = section.settings.section_height_desktop | default: 600
  assign section_height_mobile = section.settings.section_height_mobile | default: 400
  assign desktop_media_position = section.settings.desktop_media_position | default: 'left'
  assign swap_columns_mobile = section.settings.swap_columns_mobile | default: false
-%}

<script type="application/ld+json">
  {{ product | structured_data }}
</script>

{% render 'product-main-content',
  section: section,
  settings: section.settings
%}

<script>
  const productVariants = [
    {% for variant in product.variants %}
    {
      id: {{ variant.id }},
      title: "{{ variant.title | escape }}",
      price: {{ variant.price }},
      priceFormatted: "{{ variant.price | money }}",
      compare_at_price: {{ variant.compare_at_price | default: 0 }},
      compare_at_priceFormatted: "{{ variant.compare_at_price | money | default: '' }}",
      available: {{ variant.available | json }},
      option1: "{{ variant.option1 | escape }}",
      option2: "{{ variant.option2 | escape }}",
      option3: "{{ variant.option3 | escape }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  
  function changeProductImage(button) {
    const imageSrc = button.dataset.imageSrc;
    const mainImage = document.getElementById('product-main-image');
    if (mainImage && imageSrc) {
      mainImage.src = imageSrc;
      
      // Update thumbnail opacity
      document.querySelectorAll('.product-thumbnail-btn').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.querySelector('img').style.borderColor = 'transparent';
      });
      button.style.opacity = '1';
      button.querySelector('img').style.borderColor = 'var(--primary-orange, #FF6B35)';
    }
  }
  
  function zoomProductImage(img) {
    if (img.style.transform === 'scale(2)') {
      img.style.transform = 'scale(1)';
      img.style.cursor = 'pointer';
    } else {
      img.style.transform = 'scale(2)';
      img.style.cursor = 'zoom-out';
    }
  }
  
  function updateSelectedVariant() {
    const selects = document.querySelectorAll('.product-option-select');
    const selectedOptions = [];
    
    selects.forEach(select => {
      selectedOptions.push(select.value);
    });
    
    // Find matching variant
    const variant = productVariants.find(v => {
      let match = true;
      if (selectedOptions[0] && v.option1 !== selectedOptions[0]) match = false;
      if (selectedOptions[1] && v.option2 !== selectedOptions[1]) match = false;
      if (selectedOptions[2] && v.option3 !== selectedOptions[2]) match = false;
      return match;
    });
    
    if (variant) {
      // Update hidden variant ID input
      const variantIdInput = document.getElementById('selected-variant-id');
      if (variantIdInput) {
        variantIdInput.value = variant.id;
      }
      
      // Update price display
      updatePrice(variant.priceFormatted, variant.compare_at_priceFormatted, variant.price, variant.compare_at_price);
      
      // Update button state
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const buyNowBtn = document.getElementById('buy-now-btn');
      if (addToCartBtn) {
        addToCartBtn.disabled = !variant.available;
        addToCartBtn.innerHTML = variant.available 
          ? '<i class="bi bi-cart-plus me-2"></i>Add to Cart' 
          : '<i class="bi bi-x-circle me-2"></i>Out of Stock';
      }
      if (buyNowBtn) {
        buyNowBtn.disabled = !variant.available;
      }
      
      // Update app embed containers with variant information (for Sesami and other apps)
      const appEmbeds = document.querySelectorAll('.product-details-app-embed');
      appEmbeds.forEach(embed => {
        embed.setAttribute('data-variant-id', variant.id);
        embed.setAttribute('data-variant-available', variant.available);
        embed.setAttribute('data-variant-price', variant.price);
      });
      
      // Dispatch custom event for apps to listen to
      const variantChangeEvent = new CustomEvent('productVariantChange', {
        detail: {
          variantId: variant.id,
          variant: variant,
          available: variant.available,
          price: variant.price
        }
      });
      document.dispatchEvent(variantChangeEvent);
    }
  }
  
  function updatePrice(priceFormatted, compareAtPriceFormatted, price, compareAtPrice) {
    const priceContainer = document.querySelector('.product-price');
    if (!priceContainer) return;
    
    if (compareAtPrice && compareAtPrice > price && compareAtPriceFormatted) {
      const savingsCents = compareAtPrice - price;
      const savingsFormatted = (savingsCents / 100).toLocaleString('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code | default: "USD" }}'
      });
      
      priceContainer.innerHTML = `
        <span class="product-price-compare text-muted text-decoration-line-through me-2" style="font-size: 18px;">${compareAtPriceFormatted}</span>
        <span class="product-price-current text-danger" style="font-size: 24px; font-weight: 600;">${priceFormatted}</span>
        <span class="product-price-save ms-2" style="color: var(--primary-orange, #FF6B35); font-weight: 600;">Save ${savingsFormatted}</span>
      `;
    } else {
      priceContainer.innerHTML = `
        <span class="product-price-current" style="font-size: 28px; font-weight: 600;">${priceFormatted}</span>
      `;
    }
  }
  
  function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.value = parseInt(quantityInput.value) + 1;
      updateQuantityForApps(quantityInput.value);
    }
  }
  
  function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput && parseInt(quantityInput.value) > 1) {
      quantityInput.value = parseInt(quantityInput.value) - 1;
      updateQuantityForApps(quantityInput.value);
    }
  }
  
  function updateQuantityForApps(quantity) {
    // Update app embed containers with quantity information (for Sesami and other apps)
    const appEmbeds = document.querySelectorAll('.product-details-app-embed');
    appEmbeds.forEach(embed => {
      embed.setAttribute('data-quantity', quantity);
    });
    
    // Dispatch custom event for apps to listen to
    const quantityChangeEvent = new CustomEvent('productQuantityChange', {
      detail: {
        quantity: parseInt(quantity)
      }
    });
    document.dispatchEvent(quantityChangeEvent);
  }
  
  // Listen for quantity input changes
  document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.addEventListener('change', function() {
        updateQuantityForApps(this.value);
      });
      quantityInput.addEventListener('input', function() {
        updateQuantityForApps(this.value);
      });
    }
  });
  
  // Handle add to cart form submission
  const productForm = document.getElementById('product-form');
  if (productForm) {
    // Handle Add to Cart button
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(productForm);
      const addToCartBtn = document.getElementById('add-to-cart-btn');
      const originalText = addToCartBtn ? addToCartBtn.innerHTML : 'Add to Cart';
      
      // Disable button and show loading state
      if (addToCartBtn) {
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
      }
      
      // Ensure variant ID is set correctly before submission
      const variantIdInput = document.getElementById('selected-variant-id');
      if (!variantIdInput || !variantIdInput.value) {
        console.error('Variant ID is missing');
        if (addToCartBtn) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;
        }
        alert('Please select a product variant.');
        return;
      }
      
      // Ensure the form data has the correct variant ID
      formData.set('id', variantIdInput.value);
      
      // Log form data for debugging (remove in production)
      console.log('Adding to cart:', {
        variantId: variantIdInput.value,
        quantity: formData.get('quantity') || 1
      });
      
      fetch('{{ routes.cart_add_url }}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        redirect: 'follow'
      })
      .then(response => {
        // Check content type
        const contentType = response.headers.get('content-type') || '';
        const url = response.url || '';
        
        // If response URL contains 'cart', it's likely a successful redirect
        if (url.includes('/cart') || url.includes('cart')) {
          return { success: true, redirected: true, url: url };
        }
        
        // If response is HTML, check if it's the cart page (success) or error page
        if (contentType.includes('text/html')) {
          return response.text().then(html => {
            // Extract title to check
            const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
            const title = titleMatch ? titleMatch[1].toLowerCase() : '';
            
            // Check if it's the cart page (success case)
            const cartIndicators = ['cart', 'shopping cart', 'your cart', 'your shopping cart'];
            const isCartPage = cartIndicators.some(indicator => 
              title.includes(indicator) || 
              html.toLowerCase().includes(indicator)
            );
            
            if (isCartPage) {
              // This is a successful redirect to cart page
              return { success: true, redirected: true, html: true };
            }
            
            // Try to extract error message from HTML if it's an error page
            const errorMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i) || 
                              html.match(/error[^>]*>([^<]+)/i) ||
                              html.match(/alert[^>]*>([^<]+)/i);
            const errorMsg = errorMatch ? errorMatch[1] : 'Server returned an error page';
            throw new Error(errorMsg);
          });
        }
        
        // Check if response is ok
        if (!response.ok) {
          return response.text().then(text => {
            try {
              return JSON.parse(text);
            } catch {
              // If not JSON, it might be HTML or plain text
              throw new Error(text.substring(0, 200) || 'Network error');
            }
          });
        }
        
        // Try to parse as JSON
        return response.text().then(text => {
          try {
            return JSON.parse(text);
          } catch (e) {
            // If not JSON, check if it's a redirect or success
            if (text.includes('cart') || text.includes('Shopping Cart') || response.redirected) {
              // Likely a redirect to cart page - treat as success
              return { success: true, redirected: true };
            }
            throw new Error('Invalid response format');
          }
        });
      })
      .then(data => {
        // Shopify cart API can return different response formats
        if (data.success || data.id || data.items || data.status === 200 || (data.status && data.status < 400)) {
          // Success - redirect to cart
          window.location.href = '{{ routes.cart_url }}';
        } else {
          // Error handling
          if (addToCartBtn) {
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = originalText;
          }
          
          let errorMessage = 'There was an error adding the product to your cart. Please try again.';
          
          if (data.description) {
            errorMessage = 'Error: ' + data.description;
          } else if (data.message) {
            errorMessage = 'Error: ' + data.message;
          } else if (data.error) {
            errorMessage = 'Error: ' + data.error;
          } else if (typeof data === 'string') {
            errorMessage = 'Error: ' + data;
          }
          
          console.error('Add to cart error:', data);
          alert(errorMessage);
        }
      })
      .catch((error) => {
        console.error('Error adding to cart:', error);
        if (addToCartBtn) {
          addToCartBtn.disabled = false;
          addToCartBtn.innerHTML = originalText;
        }
        
        let errorMessage = 'There was an error adding the product to your cart. Please try again.';
        if (error.message) {
          errorMessage = 'Error: ' + error.message;
        }
        alert(errorMessage);
      });
    });
    
    // Handle Buy Now button (direct checkout)
    const buyNowBtn = document.getElementById('buy-now-btn');
    if (buyNowBtn) {
      buyNowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const formData = new FormData(productForm);
        const originalText = buyNowBtn.innerHTML;
        
        // Ensure variant ID is set correctly before submission
        const variantIdInput = document.getElementById('selected-variant-id');
        if (!variantIdInput || !variantIdInput.value) {
          console.error('Variant ID is missing');
          alert('Please select a product variant.');
          return;
        }
        
        // Ensure the form data has the correct variant ID
        formData.set('id', variantIdInput.value);
        
        // Disable button and show loading state
        buyNowBtn.disabled = true;
        buyNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
        
        fetch('{{ routes.cart_add_url }}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin',
          redirect: 'follow'
        })
        .then(response => {
          // Check content type
          const contentType = response.headers.get('content-type') || '';
          const url = response.url || '';
          
          // If response URL contains 'cart', it's likely a successful redirect
          if (url.includes('/cart') || url.includes('cart')) {
            return { success: true, redirected: true, url: url };
          }
          
          // If response is HTML, check if it's the cart page (success) or error page
          if (contentType.includes('text/html')) {
            return response.text().then(html => {
              // Extract title to check
              const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
              const title = titleMatch ? titleMatch[1].toLowerCase() : '';
              
              // Check if it's the cart page (success case)
              const cartIndicators = ['cart', 'shopping cart', 'your cart', 'your shopping cart'];
              const isCartPage = cartIndicators.some(indicator => 
                title.includes(indicator) || 
                html.toLowerCase().includes(indicator)
              );
              
              if (isCartPage) {
                // This is a successful redirect to cart page
                return { success: true, redirected: true, html: true };
              }
              
              // Try to extract error message from HTML if it's an error page
              const errorMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i) || 
                                html.match(/error[^>]*>([^<]+)/i) ||
                                html.match(/alert[^>]*>([^<]+)/i);
              const errorMsg = errorMatch ? errorMatch[1] : 'Server returned an error page';
              throw new Error(errorMsg);
            });
          }
          
          // Check if response is ok
          if (!response.ok) {
            return response.text().then(text => {
              try {
                return JSON.parse(text);
              } catch {
                // If not JSON, it might be HTML or plain text
                throw new Error(text.substring(0, 200) || 'Network error');
              }
            });
          }
          
          // Try to parse as JSON
          return response.text().then(text => {
            try {
              return JSON.parse(text);
            } catch (e) {
              // If not JSON, check if it's a redirect or success
              if (text.includes('cart') || text.includes('Shopping Cart') || response.redirected) {
                // Likely a redirect to cart page - treat as success
                return { success: true, redirected: true };
              }
              throw new Error('Invalid response format');
            }
          });
        })
        .then(data => {
          // Shopify cart API can return different response formats
          if (data.success || data.id || data.items || data.status === 200 || (data.status && data.status < 400)) {
            // Success - redirect directly to checkout
            window.location.href = '{{ routes.cart_url }}?view=checkout';
          } else {
            // Error handling
            buyNowBtn.disabled = false;
            buyNowBtn.innerHTML = originalText;
            
            let errorMessage = 'There was an error processing your order. Please try again.';
            
            if (data.description) {
              errorMessage = 'Error: ' + data.description;
            } else if (data.message) {
              errorMessage = 'Error: ' + data.message;
            } else if (data.error) {
              errorMessage = 'Error: ' + data.error;
            } else if (typeof data === 'string') {
              errorMessage = 'Error: ' + data;
            }
            
            console.error('Buy Now error:', data);
            alert(errorMessage);
          }
        })
        .catch((error) => {
          console.error('Error with Buy Now:', error);
          buyNowBtn.disabled = false;
          buyNowBtn.innerHTML = originalText;
          
          let errorMessage = 'There was an error processing your order. Please try again.';
          if (error.message) {
            errorMessage = 'Error: ' + error.message;
          }
          alert(errorMessage);
        });
      });
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    {% if product.variants.size > 1 %}
      updateSelectedVariant();
    {% endif %}
    
    // Initialize app embed data attributes with current variant and quantity
    const variantIdInput = document.getElementById('selected-variant-id');
    const quantityInput = document.getElementById('quantity');
    const appEmbeds = document.querySelectorAll('.product-details-app-embed');
    
    if (variantIdInput && appEmbeds.length > 0) {
      const currentVariantId = variantIdInput.value;
      const currentQuantity = quantityInput ? quantityInput.value : 1;
      
      appEmbeds.forEach(embed => {
        embed.setAttribute('data-variant-id', currentVariantId);
        embed.setAttribute('data-quantity', currentQuantity);
      });
    }
  });
  
</script>

{% schema %}
{
  "name": "Product Main",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "product-media-gallery",
      "name": "Product Media Gallery"
    },
    {
      "type": "product-details",
      "name": "Product Details"
    },
    {
      "type": "product-description",
      "name": "Product Description",
      "settings": [
        {
          "type": "select",
          "id": "text_alignment",
          "label": "Text alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            },
            {
              "value": "justify",
              "label": "Justify"
            }
          ],
          "default": "left"
        },
        {
          "type": "range",
          "id": "max_width",
          "label": "Max content width (px)",
          "min": 400,
          "max": 1200,
          "step": 50,
          "default": 800,
          "unit": "px"
        },
        {
          "type": "text",
          "id": "custom_css_class",
          "label": "Custom CSS class",
          "info": "Optional additional CSS class for custom styling"
        }
      ]
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Add custom text content here</p>"
        }
      ]
    },
    {
      "type": "richtext",
      "name": "Rich Text",
      "settings": [
        {
          "type": "richtext",
          "id": "richtext",
          "label": "Rich Text",
          "default": "<p>Add rich text content here</p>"
        }
      ]
    },
    {
      "type": "html",
      "name": "Custom HTML",
      "settings": [
        {
          "type": "html",
          "id": "html",
          "label": "HTML",
          "default": "<p>Add custom HTML content here</p>"
        }
      ]
    },
    {
      "type": "liquid",
      "name": "Custom Liquid",
      "settings": [
        {
          "type": "liquid",
          "id": "liquid",
          "label": "Liquid Code",
          "default": "<!-- Add your Liquid code here -->"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "Media Position (Desktop)",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left",
      "info": "Position of product images on desktop screens"
    },
    {
      "type": "checkbox",
      "id": "swap_columns_mobile",
      "label": "Swap Columns on Mobile",
      "default": false,
      "info": "Show product details above images on mobile"
    },
    {
      "type": "header",
      "content": "Section Height"
    },
    {
      "type": "range",
      "id": "section_height_desktop",
      "label": "Section Height - Desktop (px)",
      "min": 200,
      "max": 1500,
      "step": 50,
      "default": 600,
      "unit": "px",
      "info": "Height of section on desktop screens (992px and above)"
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "label": "Section Height - Mobile (px)",
      "min": 200,
      "max": 1000,
      "step": 50,
      "default": 400,
      "unit": "px",
      "info": "Height of section on mobile screens (below 992px)"
    },
    {
      "type": "header",
      "content": "Spacing - Desktop"
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Top Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Bottom Padding - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_desktop",
      "label": "Horizontal Padding - Desktop (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_desktop",
      "label": "Top Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_desktop",
      "label": "Bottom Margin - Desktop (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Spacing - Mobile"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Top Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Bottom Padding - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal_mobile",
      "label": "Horizontal Padding - Mobile (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_mobile",
      "label": "Top Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_mobile",
      "label": "Bottom Margin - Mobile (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Product Main",
      "blocks": [
        {
          "type": "product-media-gallery"
        },
        {
          "type": "product-details"
        },
        {
          "type": "product-description"
        }
      ]
    }
  ]
}
{% endschema %}
