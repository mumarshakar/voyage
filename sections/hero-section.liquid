{% schema %}
{
  "name": "Hero Section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "A WELLNESS EXPERIENCE."
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Your perfect journey starts here. Book your next adventure with ease."
    },
    {
      "type": "header",
      "content": "Button 1 Settings"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button 1 Text",
      "default": "BOOK YOUR GLOW"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button 1 Link"
    },
    {
      "type": "header",
      "content": "Button 2 Settings"
    },
    {
      "type": "text",
      "id": "button_2_text",
      "label": "Button 2 Text",
      "default": "Learn More"
    },
    {
      "type": "url",
      "id": "button_2_link",
      "label": "Button 2 Link"
    },
    {
      "type": "header",
      "content": "Background Media"
    },
    {
      "type": "select",
      "id": "background_type",
      "label": "Background Type",
      "options": [
        {
          "value": "image",
          "label": "Image"
        },
        {
          "value": "video",
          "label": "Video"
        }
      ],
      "default": "image"
    },
    {
      "type": "select",
      "id": "image_source_type",
      "label": "Image Source",
      "options": [
        {
          "value": "upload",
          "label": "Upload to Shopify"
        },
        {
          "value": "url",
          "label": "External URL"
        }
      ],
      "default": "upload",
      "info": "Choose how to provide the image (when background type is Image)"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Desktop Background Image",
      "info": "Upload image for desktop (used when image source is Upload)"
    },
    {
      "type": "image_picker",
      "id": "background_image_mobile",
      "label": "Mobile Background Image",
      "info": "Upload image for mobile (optional, falls back to desktop if not set)"
    },
    {
      "type": "text",
      "id": "background_image_desktop_url",
      "label": "Desktop Background Image URL",
      "info": "External image URL for desktop (e.g., https://example.com/image.jpg). Used when image source is External URL"
    },
    {
      "type": "text",
      "id": "background_image_mobile_url",
      "label": "Mobile Background Image URL",
      "info": "External image URL for mobile (optional, falls back to desktop if not set)"
    },
    {
      "type": "select",
      "id": "video_source_type",
      "label": "Video Source",
      "options": [
        {
          "value": "upload",
          "label": "Upload to Shopify"
        },
        {
          "value": "url",
          "label": "External URL (YouTube, Vimeo, etc.)"
        }
      ],
      "default": "upload",
      "info": "Choose how to provide the video"
    },
    {
      "type": "video",
      "id": "background_video_desktop",
      "label": "Desktop Background Video",
      "info": "Upload MP4 video for desktop (max 1GB, H.264 codec recommended)"
    },
    {
      "type": "text",
      "id": "background_video_desktop_url",
      "label": "Desktop Video URL",
      "info": "Direct video URL (e.g., https://example.com/video.mp4) or YouTube/Vimeo embed URL"
    },
    {
      "type": "video",
      "id": "background_video_mobile",
      "label": "Mobile Background Video",
      "info": "Upload MP4 video for mobile (optional, falls back to desktop if not set)"
    },
    {
      "type": "text",
      "id": "background_video_mobile_url",
      "label": "Mobile Video URL",
      "info": "Direct video URL for mobile (optional)"
    },
    {
      "type": "checkbox",
      "id": "video_autoplay",
      "label": "Autoplay Video",
      "default": true,
      "info": "Video will autoplay and loop"
    },
    {
      "type": "checkbox",
      "id": "video_muted",
      "label": "Mute Video",
      "default": true,
      "info": "Video will be muted (required for autoplay in most browsers)"
    },
    {
      "type": "header",
      "content": "Hero Section Layout"
    },
    {
      "type": "range",
      "id": "hero_height",
      "label": "Hero Height (vh)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "vh"
    },
    {
      "type": "range",
      "id": "hero_height_mobile",
      "label": "Hero Height (Mobile vh)",
      "min": 40,
      "max": 100,
      "step": 5,
      "default": 70,
      "unit": "vh"
    },
    {
      "type": "select",
      "id": "background_position",
      "label": "Background Image Position",
      "options": [
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "top",
          "label": "Top"
        },
        {
          "value": "bottom",
          "label": "Bottom"
        },
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "background_size",
      "label": "Background Image Size",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        },
        {
          "value": "auto",
          "label": "Auto"
        }
      ],
      "default": "cover"
    },
    {
      "type": "header",
      "content": "Title Settings"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#8B6F47",
      "info": "Change the color of the hero section title"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle Color",
      "default": "#FFFFFF",
      "info": "Change the color of the hero section subtitle"
    },
    {
      "type": "paragraph",
      "content": "Typography (font size, line height, font weight, font family) is controlled by Theme Settings > Typography"
    },
    {
      "type": "range",
      "id": "title_position_top",
      "label": "Title Position from Top (%)",
      "min": 5,
      "max": 50,
      "step": 1,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Button Position"
    },
    {
      "type": "range",
      "id": "button_position_bottom",
      "label": "Buttons Position from Bottom (%)",
      "min": 5,
      "max": 30,
      "step": 1,
      "default": 15,
      "unit": "%",
      "info": "Position for both buttons. Button styling (colors, borders) is controlled by Theme Settings > Buttons"
    },
    {
      "type": "header",
      "content": "Overlay Settings"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay Opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "default": 0,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top Padding (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 120,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom Padding (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_horizontal",
      "label": "Horizontal Padding (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Margin (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom Margin (px)",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 0,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Hero Section"
    }
  ]
}
{% endschema %}

{%- liquid
    assign bg_position = section.settings.background_position | default: 'center'
    assign bg_size = section.settings.background_size | default: 'cover'
    assign title_position_top = section.settings.title_position_top | default: 20
    assign text_align = section.settings.text_alignment | default: 'center'
    assign button_position_bottom = section.settings.button_position_bottom | default: 15
    assign overlay_color = section.settings.overlay_color | default: '#000000'
    assign overlay_opacity = section.settings.overlay_opacity | default: 0
    if overlay_opacity == blank
      assign overlay_opacity = 0
    endif
    assign padding_top = section.settings.padding_top | default: 120
    assign padding_bottom = section.settings.padding_bottom | default: 80
    assign padding_horizontal = section.settings.padding_horizontal | default: 20
    assign margin_top = section.settings.margin_top | default: 0
    assign margin_bottom = section.settings.margin_bottom | default: 0
    assign background_type = section.settings.background_type | default: 'image'
    assign image_source_type = section.settings.image_source_type | default: 'upload'
    assign video_source_type = section.settings.video_source_type | default: 'upload'
    assign video_autoplay = section.settings.video_autoplay | default: true
    assign video_muted = section.settings.video_muted | default: true
    
    # Handle image sources (upload or URL)
    if background_type == 'image'
      if image_source_type == 'upload'
        assign desktop_image = section.settings.background_image
        assign mobile_image = section.settings.background_image_mobile
        if desktop_image != blank
          assign desktop_image_url = desktop_image | image_url: width: 1920
        endif
        if mobile_image != blank
          assign mobile_image_url = mobile_image | image_url: width: 768
        else
          assign mobile_image_url = desktop_image_url
        endif
      else
        assign desktop_image_url = section.settings.background_image_desktop_url
        assign mobile_image_url = section.settings.background_image_mobile_url
        if mobile_image_url == blank
          assign mobile_image_url = desktop_image_url
        endif
      endif
      assign has_background_image = true
      if desktop_image_url == blank
        assign has_background_image = false
      endif
    else
      assign has_background_image = false
    endif
    
    # Get heading theme settings for typography
    assign heading_color = settings.heading_color | default: '#333333'
    
    # Use section title_color if provided, otherwise use theme heading_color
    assign section_title_color = section.settings.title_color
    if section_title_color != blank
      assign title_color = section_title_color
    else
      assign title_color = heading_color
    endif
    
    # Use section subtitle_color if provided, otherwise default to white
    assign section_subtitle_color = section.settings.subtitle_color
    if section_subtitle_color != blank
      assign subtitle_color = section_subtitle_color
    else
      assign subtitle_color = '#FFFFFF'
    endif
    
    # All typography comes from theme settings - no section-specific font sizes
    
    assign overlay_opacity_decimal = overlay_opacity | divided_by: 100.0
  -%}
  
  <section class="hero-section hero-glow {% if has_background_image %}hero-has-image{% endif %}" 
           style="min-height: calc(var(--vh, 1vh) * {{ section.settings.hero_height }});
                  --hero-mobile-height-setting: calc(var(--vh, 1vh) * {{ section.settings.hero_height_mobile }});
                  {% if has_background_image and desktop_image_url != blank %}--hero-bg-image-desktop: url('{{ desktop_image_url }}');{% endif %}
                  {% if has_background_image and mobile_image_url != blank %}--hero-bg-image-mobile: url('{{ mobile_image_url }}');{% endif %}
                  background-position: {{ bg_position }};
                  background-size: {{ bg_size }};
                  {% if has_background_image %}background-image: var(--hero-bg-image-desktop);{% endif %}
                  padding-top: {{ padding_top }}px;
                  padding-bottom: {{ padding_bottom }}px;
                  padding-left: {{ padding_horizontal }}px;
                  padding-right: {{ padding_horizontal }}px;
                  margin-top: {{ margin_top }}px;
                  margin-bottom: {{ margin_bottom }}px;
                  position: relative;
                  overflow: hidden;">
    {% if background_type == 'video' %}
      {%- liquid
        if video_source_type == 'upload'
          assign desktop_video = section.settings.background_video_desktop
          assign mobile_video = section.settings.background_video_mobile
        else
          assign desktop_video_url = section.settings.background_video_desktop_url
          assign mobile_video_url = section.settings.background_video_mobile_url
        endif
      -%}
      
      {% if video_source_type == 'upload' and desktop_video != blank %}
        <div class="hero-video-container" data-has-image="{% if section.settings.background_image != blank %}true{% else %}false{% endif %}">
          {% if mobile_video != blank %}
            <video class="hero-video hero-video-mobile" 
                   playsinline 
                   {% if video_autoplay %}autoplay{% endif %} 
                   {% if video_muted %}muted{% endif %} 
                   loop 
                   preload="auto"
                   {% if mobile_video.width %}width="{{ mobile_video.width }}"{% endif %}
                   {% if mobile_video.height %}height="{{ mobile_video.height }}"{% endif %}>
              {% comment %} theme-check-disable RemoteAsset {% endcomment %}
              {% assign mobile_sources_reversed = mobile_video.sources | reverse %}
              {% for source in mobile_sources_reversed %}
                <source src="{{ source.url }}" type="{{ source.mime_type }}">
              {% endfor %}
              {% comment %} theme-check-enable RemoteAsset {% endcomment %}
            </video>
          {% endif %}
          <video class="hero-video hero-video-desktop" 
                 playsinline 
                 {% if video_autoplay %}autoplay{% endif %} 
                 {% if video_muted %}muted{% endif %} 
                 loop 
                 preload="auto"
                 {% if desktop_video.width %}width="{{ desktop_video.width }}"{% endif %}
                 {% if desktop_video.height %}height="{{ desktop_video.height }}"{% endif %}>
            {% comment %} theme-check-disable RemoteAsset {% endcomment %}
            {% assign desktop_sources_reversed = desktop_video.sources | reverse %}
            {% for source in desktop_sources_reversed %}
              <source src="{{ source.url }}" type="{{ source.mime_type }}">
            {% endfor %}
            {% comment %} theme-check-enable RemoteAsset {% endcomment %}
          </video>
        </div>
      {% elsif video_source_type == 'url' and desktop_video_url != blank %}
        <div class="hero-video-container">
          {% if mobile_video_url != blank %}
            <video class="hero-video hero-video-mobile" 
                   playsinline 
                   {% if video_autoplay %}autoplay{% endif %} 
                   {% if video_muted %}muted{% endif %} 
                   loop 
                   preload="auto">
              {% comment %} theme-check-disable RemoteAsset {% endcomment %}
              <source src="{{ mobile_video_url }}" type="video/mp4">
              {% comment %} theme-check-enable RemoteAsset {% endcomment %}
            </video>
          {% endif %}
          <video class="hero-video hero-video-desktop" 
                 playsinline 
                 {% if video_autoplay %}autoplay{% endif %} 
                 {% if video_muted %}muted{% endif %} 
                 loop 
                 preload="auto">
            {% comment %} theme-check-disable RemoteAsset {% endcomment %}
            <source src="{{ desktop_video_url }}" type="video/mp4">
            {% comment %} theme-check-enable RemoteAsset {% endcomment %}
          </video>
        </div>
      {% endif %}
    {% endif %}
    <div class="hero-overlay" style="background-color: {{ overlay_color }}; opacity: {{ overlay_opacity_decimal }};"></div>
    <div class="hero-glow-content" style="text-align: {{ text_align }};">
      <h1 class="hero-glow-title" 
          style="color: {{ title_color }} !important;
                 margin-top: {{ title_position_top }}%;
                 margin-bottom: {% if section.settings.subtitle != blank %}20px{% else %}0{% endif %};">
        {{ section.settings.title }}
      </h1>
      {% if section.settings.subtitle != blank %}
        <p class="hero-glow-subtitle" 
           style="color: {{ subtitle_color }} !important;
                  margin-bottom: 30px;
                  max-width: 800px;
                  margin-left: auto;
                  margin-right: auto;">
          {{ section.settings.subtitle }}
        </p>
      {% endif %}
      {% if section.settings.button_link != blank or section.settings.button_2_link != blank %}
        <div class="hero-buttons-wrapper" style="margin-bottom: {{ button_position_bottom }}%;">
          {% if section.settings.button_link != blank %}
            <a href="{{ section.settings.button_link }}" class="btn-glow-cta btn-glow-cta-primary">
              {{ section.settings.button_text }}
            </a>
          {% endif %}
          {% if section.settings.button_2_link != blank %}
            <a href="{{ section.settings.button_2_link }}" class="btn-glow-cta btn-glow-cta-secondary">
              {{ section.settings.button_2_text }}
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </section>

<style>
@media screen and (max-width: 767px) {
  .hero-section.hero-glow {
      min-height: calc(var(--vh, 1vh) * {{ section.settings.hero_height_mobile }}) !important;
      {% if has_background_image and mobile_image_url != blank %}
      background-image: var(--hero-bg-image-mobile) !important;
      {% endif %}
  }
}
#shopify-section-{{ section.id }} .hero-section.hero-glow {
    {% if has_background_image %}
    background-repeat: no-repeat;
    background-attachment: scroll;
    {% endif %}
}

/* Hero Buttons Wrapper - Side by side layout */
.hero-buttons-wrapper {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  width: 100%;
}

.hero-buttons-wrapper .btn-glow-cta {
  margin-bottom: 0;
}

@media (max-width: 767px) {
  .hero-buttons-wrapper {
    flex-direction: column;
    gap: 15px;
    width: 100%;
  }
  
  .hero-buttons-wrapper .btn-glow-cta {
    width: 100%;
    max-width: 300px;
  }
}
</style>

<script>
  (function() {
    const hero = document.querySelector('#shopify-section-{{ section.id }} .hero-section.hero-glow');
    if (!hero) return;
    
    const videoContainers = hero.querySelectorAll('.hero-video-container');
    if (!videoContainers.length) return;
    
    const mobileVideo = hero.querySelector('.hero-video-mobile');
    const MOBILE_BREAKPOINT = 768;
    
    function setHeroHeightFromVideo(video) {
      if (!video || window.innerWidth > MOBILE_BREAKPOINT) return;
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      if (!videoWidth || !videoHeight) return;
      const containerWidth = hero.clientWidth || window.innerWidth;
      const targetHeight = containerWidth * (videoHeight / videoWidth);
      hero.style.setProperty('--hero-mobile-video-height', `${targetHeight}px`);
      hero.classList.add('hero-mobile-video-fit');
    }
    
    function clearHeroHeightAdjustment() {
      hero.classList.remove('hero-mobile-video-fit');
      hero.style.removeProperty('--hero-mobile-video-height');
    }
    
    function handleResize() {
      if (window.innerWidth <= MOBILE_BREAKPOINT && mobileVideo) {
        setHeroHeightFromVideo(mobileVideo);
      } else {
        clearHeroHeightAdjustment();
      }
    }
    
    function forceHighestQualitySource(video) {
      if (!video) return;
      
      // Get all source elements (already reversed in Liquid, so first is highest)
      const sources = Array.from(video.querySelectorAll('source'));
      if (sources.length === 0) return;
      
      // Use the first source (highest quality after reverse) as primary src
      const bestSource = sources[0];
      
      if (bestSource && bestSource.src) {
        // Set as primary src attribute to prioritize highest quality
        // Browser will use this before checking <source> elements
        video.setAttribute('src', bestSource.src);
        
        // Ensure preload is set for quality detection
        video.preload = 'auto';
        
        // Load the video
        video.load();
      }
    }
    
    videoContainers.forEach((container) => {
      const videos = container.querySelectorAll('video');
      videos.forEach((video) => {
        if (!video) return;
        
        // Force highest quality source for Shopify videos
        forceHighestQualitySource(video);
        
        const revealVideo = () => {
          video.classList.add('hero-video-ready');
        };
        
        if (video.readyState >= 2) {
          revealVideo();
        } else {
          video.addEventListener('loadeddata', revealVideo, { once: true });
          video.addEventListener('canplay', revealVideo, { once: true });
        }
        
        if (video === mobileVideo) {
          const adjust = () => setHeroHeightFromVideo(video);
          if (video.readyState >= 1) {
            adjust();
          } else {
            video.addEventListener('loadedmetadata', adjust, { once: true });
          }
        }
      });
    });
    
    window.addEventListener('resize', () => {
      clearTimeout(hero._mobileVideoResizeTimer);
      hero._mobileVideoResizeTimer = setTimeout(handleResize, 200);
    });
    
    handleResize();
  })();
</script>

