<div class="container my-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      {%- if cart.item_count > 0 -%}
        <h1 class="mb-4">Your Cart</h1>
        <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-form">
          <div class="card mb-4">
            <div class="card-body">
              {%- for item in cart.items -%}
                <div class="row align-items-center mb-3 pb-3 {% unless forloop.last %}border-bottom{% endunless %} cart-item" data-key="{{ item.key }}">
                  <div class="col-md-2 col-4">
                    <img class="img-fluid rounded" src="{{ item.image | image_url: width: 100 }}" alt="{{ item.product.title }}" width="100" height="100">
                  </div>
                  <div class="col-md-4 col-8">
                    <h5 class="mb-0">{{ item.product.title }}</h5>
                    {%- if item.variant.title != 'Default Title' -%}
                      <p class="text-muted mb-0">{{ item.variant.title }}</p>
                    {%- endif -%}
                    <a href="#" class="text-danger remove-item" data-key="{{ item.key }}">Remove</a>
                  </div>
                  <div class="col-md-2 col-4 text-md-start text-end">
                    <p class="mb-0">{{ item.price | money }}</p>
                  </div>
                  <div class="col-md-2 col-4">
                    <div class="input-group input-group-sm">
                      <button type="button" class="btn btn-outline-secondary quantity-btn" data-change="-1">-</button>
                      <input type="number" name="updates[]" id="updates_{{ item.key }}" value="{{ item.quantity }}" min="0" class="form-control text-center quantity-input" data-key="{{ item.key }}">
                      <button type="button" class="btn btn-outline-secondary quantity-btn" data-change="1">+</button>
                    </div>
                  </div>
                  <div class="col-md-2 col-4 text-end">
                    <p class="mb-0">{{ item.line_price | money }}</p>
                  </div>
                </div>
              {%- endfor -%}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="note" class="form-label">Add a note to your order:</label>
                <textarea name="note" id="note" rows="3" class="form-control">{{ cart.note }}</textarea>
              </div>
            </div>
            <div class="col-md-6 text-end">
              <p class="h5">Subtotal: <span class="cart-total">{{ cart.total_price | money }}</span></p>
              <p class="text-muted">Taxes and shipping calculated at checkout.</p>
              <div class="mt-3">
                <button type="submit" name="update" class="btn btn-outline-primary me-2">Update Cart</button>
                <button type="submit" name="checkout" class="btn btn-primary">Checkout</button>
              </div>
            </div>
          </div>
        </form>
      {%- else -%}
        <div class="text-center py-5">
          <h1 class="display-5 mb-3">Your cart is empty</h1>
          <p class="lead">Looks like you haven't added anything to your cart yet.</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn btn-primary mt-3">Continue Shopping</a>
        </div>
      {%- endif -%}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const cartForm = document.querySelector('.cart-form');

  if (cartForm) {
    cartForm.addEventListener('click', function(e) {
      if (e.target.classList.contains('quantity-btn')) {
        const change = parseInt(e.target.dataset.change);
        const input = e.target.parentElement.querySelector('.quantity-input');
        const currentValue = parseInt(input.value);
        const newValue = currentValue + change;

        if (newValue >= 0) {
          input.value = newValue;
          updateCart(input.dataset.key, newValue);
        }
      }

      if (e.target.classList.contains('remove-item')) {
        e.preventDefault();
        const key = e.target.dataset.key;
        updateCart(key, 0);
      }
    });

    cartForm.addEventListener('change', function(e) {
      if (e.target.classList.contains('quantity-input')) {
        const key = e.target.dataset.key;
        const quantity = parseInt(e.target.value);
        updateCart(key, quantity);
      }
    });
  }

  function updateCart(key, quantity) {
    fetch('{{ routes.cart_change_url }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        id: key,
        quantity: quantity
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.item_count === 0) {
        location.reload();
      } else {
        const cartItem = document.querySelector(`.cart-item[data-key="${key}"]`);
        if (quantity === 0) {
          cartItem.remove();
        } else {
          // Update the line price for the specific item
          const updatedItem = data.items.find(item => item.key === key);
          if (updatedItem) {
            const linePriceElement = cartItem.querySelector('.col-md-2.col-4.text-end p');
            if (linePriceElement) {
              // Use Shopify.formatMoney if available, otherwise format manually
              if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
                linePriceElement.textContent = Shopify.formatMoney(updatedItem.line_price);
              } else {
                // Fallback: format money manually
                const price = (updatedItem.line_price / 100).toFixed(2);
                linePriceElement.textContent = '{{ cart.currency.symbol }}' + parseFloat(price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        }
        const cartTotalElement = document.querySelector('.cart-total');
        if (cartTotalElement) {
          // Use Shopify.formatMoney if available, otherwise format manually
          if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
            cartTotalElement.textContent = Shopify.formatMoney(data.total_price);
          } else {
            // Fallback: format money manually
            const total = (data.total_price / 100).toFixed(2);
            cartTotalElement.textContent = '{{ cart.currency.symbol }}' + parseFloat(total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          }
        }
      }
    })
    .catch((error) => {
      console.error('Error:', error);
      // Reload page on error to ensure cart state is correct
      location.reload();
    });
  }
});
</script>

{% schema %}
{
  "name": "Cart Main",
  "class": "cart-main-section",
  "settings": []
}
{% endschema %}
