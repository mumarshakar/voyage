<div class="container mx-auto px-4 sm:px-6 lg:px-8">
  <div class="max-w-4xl mx-auto">
    {%- if cart.item_count > 0 -%}
      <h1 class="text-3xl font-bold text-gray-900 mb-8">Your Cart</h1>
      <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-form">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200 cart-items">
            {%- for item in cart.items -%}
              <tr class="cart-item" data-key="{{ item.key }}">
                <td class="px-6 py-4 whitespace-nowrap" data-label="Product">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <img class="h-10 w-10 rounded-full" src="{{ item.image | image_url: width: 100 }}" alt="">
                    </div>
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900">{{ item.product.title }}</div>
                      <div class="text-sm text-gray-500">{{ item.variant.title }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap" data-label="Price">
                  <div class="text-sm text-gray-900">{{ item.price | money }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap" data-label="Quantity">
                  <div class="flex items-center">
                    <button type="button" class="quantity-btn" data-change="-1">-</button>
                    <input type="number" name="updates[]" id="updates_{{ item.key }}" value="{{ item.quantity }}" min="0" class="w-16 text-center quantity-input" data-key="{{ item.key }}">
                    <button type="button" class="quantity-btn" data-change="1">+</button>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium" data-label="Remove">
                  <a href="#" class="text-indigo-600 hover:text-indigo-900 remove-item" data-key="{{ item.key }}">Remove</a>
                </td>
              </tr>
            {%- endfor -%}
          </tbody>
        </table>
        <div class="mt-8 flex justify-between items-center">
          <div>
            <label for="note" class="block text-sm font-medium text-gray-700">Add a note to your order:</label>
            <textarea name="note" id="note" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm focus:ring-indigo-500 focus:border-indigo-500 border-gray-300 rounded-md">{{ cart.note }}</textarea>
          </div>
          <div class="text-right">
            <p class="text-lg font-medium text-gray-900">Subtotal: <span class="cart-total">{{ cart.total_price | money }}</span></p>
            <p class="mt-1 text-sm text-gray-500">Taxes and shipping calculated at checkout.</p>
            <div class="mt-4">
              <button type="submit" name="update" class="button-secondary">Update Cart</button>
              <button type="submit" name="checkout" class="button-primary ml-4">Checkout</button>
            </div>
          </div>
        </div>
      </form>
    {%- else -%}
      <div class="text-center py-20">
        <h1 class="text-3xl font-bold text-gray-900">Your cart is empty</h1>
        <p class="mt-4 text-lg text-gray-600">Continue browsing <a href="{{ routes.all_products_collection_url }}" class="text-indigo-600 hover:text-indigo-900">here</a>.</p>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const cartForm = document.querySelector('.cart-form');

  if (cartForm) {
    cartForm.addEventListener('click', function(e) {
      if (e.target.classList.contains('quantity-btn')) {
        const change = parseInt(e.target.dataset.change);
        const input = e.target.parentElement.querySelector('.quantity-input');
        const currentValue = parseInt(input.value);
        const newValue = currentValue + change;

        if (newValue >= 0) {
          input.value = newValue;
          updateCart(input.dataset.key, newValue);
        }
      }

      if (e.target.classList.contains('remove-item')) {
        e.preventDefault();
        const key = e.target.dataset.key;
        updateCart(key, 0);
      }
    });

    cartForm.addEventListener('change', function(e) {
      if (e.target.classList.contains('quantity-input')) {
        const key = e.target.dataset.key;
        const quantity = parseInt(e.target.value);
        updateCart(key, quantity);
      }
    });
  }

  function updateCart(key, quantity) {
    fetch('{{ routes.cart_change_url }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        id: key,
        quantity: quantity
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.item_count === 0) {
        location.reload();
      } else {
        const item = data.items.find(item => item.key === key);
        const cartItem = document.querySelector(`.cart-item[data-key="${key}"]`);

        if (quantity === 0) {
          cartItem.remove();
        } else {
          // This is a simplified update. For a real-world scenario, you'd want to update the total price of the item as well.
        }

        document.querySelector('.cart-total').textContent = Shopify.formatMoney(data.total_price);
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }
});
</script>

{% schema %}
{
  "name": "Cart Main",
  "class": "cart-main-section",
  "settings": []
}
{% endschema %}
